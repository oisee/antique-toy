# Приложение E: Краткий справочник по eZ80

> *«Тот же набор инструкций, совершенно другая машина.»*
> -- Глава 22

Это приложение --- справочная карточка для программистов Z80, впервые подступающихся к eZ80. Оно охватывает архитектурные различия, систему режимов, новые инструкции и особенности Agon Light 2, которые нужно учитывать при портировании. Это не исчерпывающее руководство по eZ80 --- это подмножество, важное для работы в Главе 22.

Если ты уже знаешь Z80 (а если дочитал до сюда --- знаешь), eZ80 покажется знакомым. Регистры называются так же, инструкции имеют те же мнемоники, флаги работают одинаково. Но три вещи отличаются: адреса стали 24-битными, регистры могут быть 24-битными, и есть система режимов, которая управляет активной шириной. Всё остальное следует из этого.

---

## 1. Обзор архитектуры

eZ80 --- это расширенный Z80 от Zilog, разработанный для встраиваемых систем, которым нужно больше 64 КБ адресного пространства. Это строгое надмножество Z80 --- каждый опкод Z80 допустим на eZ80 с идентичным поведением. Расширения добавляют 24-битную адресацию, 24-битную ширину регистров и несколько новых инструкций.

| Характеристика | Z80 | eZ80 |
|---------|-----|------|
| Ширина адреса | 16-бит (64 КБ) | 24-бит (16 МБ) |
| Ширина регистров | 16-бит (HL, BC, DE, SP, IX, IY) | 16-бит или 24-бит (зависит от режима) |
| Размер стекового кадра на PUSH/CALL | 2 байта | 2 байта (режим Z80) или 3 байта (режим ADL) |
| Аппаратное умножение | Нет | MLT rr (8x8 без знака) |
| Префиксы инструкций | CB, DD, ED, FD | Те же, плюс префиксы суффиксов режима |
| Регистр MBASE | Н/Д | Предоставляет старшие 8 бит адреса в режиме Z80 |
| Новые инструкции | Н/Д | LEA, PEA, MLT, TST, TSTIO, SLP, IN0/OUT0, STMIX/RSMIX |

Ключевая ментальная модель: в **режиме ADL** (Address Data Long) eZ80 ведёт себя как Z80 с 24-битными регистрами и 24-битными адресами. В **Z80-совместимом режиме** он ведёт себя как стандартный Z80, с 16-битными регистрами, а регистр MBASE предоставляет недостающие старшие 8 бит адреса.

---

## 2. Система режимов

У eZ80 есть два рабочих режима, управляющих шириной регистров и генерацией адресов. Понимание этих режимов --- самая важная концепция для любого Z80-программиста, изучающего eZ80.

### Два режима

**Z80-совместимый режим.** Регистры 16-битные. Адреса 16-битные, старшие 8 бит предоставляет MBASE. `LD HL,$4000` загружает 16-битное значение. `PUSH HL` помещает в стек 2 байта. Код ведёт себя точно так же, как на стандартном Z80.

**Режим ADL (Address Data Long).** Регистры 24-битные. Адреса 24-битные. `LD HL,$040000` загружает 24-битное значение. `PUSH HL` помещает в стек 3 байта. Это родной режим eZ80 и режим по умолчанию на Agon Light 2.

### Суффиксы режима

Отдельные инструкции могут переопределять текущий режим с помощью суффиксных префиксов:

| Суффикс | Значение | Ширина регистров | Ширина адреса |
|--------|---------|----------------|---------------|
| `.SIS` | Short Immediate, Short | 16-бит | 16-бит |
| `.LIS` | Long Immediate, Short | 24-бит | 16-бит |
| `.SIL` | Short Immediate, Long | 16-бит | 24-бит |
| `.LIL` | Long Immediate, Long | 24-бит | 24-бит |

Первая буква (S/L) управляет шириной регистров для данной инструкции. Третья буква (S/L) управляет шириной адреса. В режиме ADL `.SIS` заставляет инструкцию работать как стандартный Z80. В режиме Z80 `.LIL` заставляет инструкцию работать в полном 24-битном режиме.

### Вызовы и переходы с переключением режима

Вызовы и переходы могут переключать режим процессора в точке назначения:

| Инструкция | Текущий режим | Целевой режим | Размер адреса возврата |
|-------------|-------------|-------------|---------------------|
| `CALL.IS nn` | ADL | Z80 | 3 байта (конвенция ADL) |
| `CALL.IL nn` | Z80 | ADL | 3 байта (длинный) |
| `JP.SIS nn` | любой | Z80 | Н/Д (нет адреса возврата) |
| `JP.LIL nn` | любой | ADL | Н/Д (нет адреса возврата) |
| `RST.LIL $08` | Z80 | ADL | 3 байта (длинный) |

Суффикс `.IS` означает «Instruction Short» --- целевой код работает в режиме Z80. `.IL` означает «Instruction Long» --- целевой код работает в режиме ADL.

### Практическое правило

**Оставайся в режиме ADL.** MOS загружает Agon в режиме ADL. Вызовы MOS API ожидают режим ADL. Команды VDP отправляются через подпрограммы MOS, которые предполагают 24-битные стековые кадры. Если ты переключишься в режим Z80 и вызовешь MOS, несоответствие ширины стекового кадра разрушит стек и приведёт к краху.

Если тебе нужны плотные 16-битные циклы (например, портирование внутреннего цикла Z80 без переписывания), используй суффикс `.SIS` для отдельных инструкций, а не переключай весь процессор.

### Ловушка MBASE

В Z80-совместимом режиме регистр MBASE предоставляет старшие 8 бит каждого адреса памяти --- включая выборку инструкций. Если ты изменишь MBASE во время выполнения в режиме Z80, следующая выборка инструкции использует новое значение MBASE. Если твой код не находится по соответствующему физическому адресу, выполнение уйдёт в мусор.

Правило: если тебе необходимо использовать режим Z80, установи MBASE один раз при запуске и не трогай его. А лучше --- оставайся в режиме ADL.

---

## 3. Новые инструкции

Эти инструкции существуют на eZ80, но отсутствуют на стандартном Z80. Именно они делают eZ80 чем-то большим, чем просто Z80 с расширенными регистрами.

### Арифметика и тесты

| Инструкция | Байт | Тактов | Описание |
|-------------|-------|--------|-------------|
| `MLT BC` | 2 | 6 | Беззнаковое умножение 8x8: B * C -> BC |
| `MLT DE` | 2 | 6 | Беззнаковое умножение 8x8: D * E -> DE |
| `MLT HL` | 2 | 6 | Беззнаковое умножение 8x8: H * L -> HL |
| `MLT SP` | 2 | 6 | Беззнаковое умножение 8x8: SPH * SPL -> SP (редко полезно) |
| `TST A, n` | 3 | 7 | Тест: A AND n, устанавливает флаги, A не изменяется |
| `TST A, r` | 2 | 4 | Тест: A AND r, устанавливает флаги, A не изменяется |
| `TSTIO n` | 3 | 12 | Тест ввода-вывода: (C) AND n, устанавливает флаги |

### Вычисление адресов

| Инструкция | Байт | Тактов | Описание |
|-------------|-------|--------|-------------|
| `LEA BC, IX+d` | 3 | 4 | BC = IX + смещение d со знаком |
| `LEA DE, IX+d` | 3 | 4 | DE = IX + d |
| `LEA HL, IX+d` | 3 | 4 | HL = IX + d |
| `LEA IX, IX+d` | 3 | 4 | IX = IX + d (прибавить смещение к IX) |
| `LEA BC, IY+d` | 3 | 4 | BC = IY + d |
| `LEA DE, IY+d` | 3 | 4 | DE = IY + d |
| `LEA HL, IY+d` | 3 | 4 | HL = IY + d |
| `LEA IY, IY+d` | 3 | 4 | IY = IY + d (прибавить смещение к IY) |
| `PEA IX+d` | 3 | 7 | Поместить (IX + d) в стек |
| `PEA IY+d` | 3 | 7 | Поместить (IY + d) в стек |

LEA вычисляет эффективный адрес без обращения к памяти --- это чистая регистровая арифметика. На стандартном Z80 вычисление `HL = IX + 5` требует многоинструкционной последовательности (`PUSH IX / POP HL / LD DE,5 / ADD HL,DE`). LEA делает это одной инструкцией за 4 такта.

### Ввод-вывод и системные инструкции

| Инструкция | Байт | Тактов | Описание |
|-------------|-------|--------|-------------|
| `IN0 r, (n)` | 3 | 7 | Чтение из внутреннего порта ввода-вывода (8-битный адрес) |
| `OUT0 (n), r` | 3 | 7 | Запись во внутренний порт ввода-вывода (8-битный адрес) |
| `SLP` | 2 | -- | Сон: остановить CPU до прерывания (меньше энергии, чем HALT) |
| `STMIX` | 2 | 4 | Установить флаг смешанного режима (включить чередование ADL/Z80) |
| `RSMIX` | 2 | 4 | Сбросить флаг смешанного режима |

IN0/OUT0 используют 8-битный адрес порта (в отличие от стандартных IN/OUT, которые могут использовать 16-битные адреса портов через BC). Они предназначены для внутренних периферийных устройств eZ80 и редко используются в игровом коде для Agon.

---

## 4. MLT --- Революционная инструкция

Из всех новых инструкций eZ80 MLT оказывает наибольшее влияние на игровой и демо-код. Она выполняет беззнаковое умножение 8x8 одной инструкцией.

На стандартном Z80 умножение 8x8 требует цикла сдвигов и сложений:

```z80
; Z80: 8x8 unsigned multiply (B * C -> A:C)
; Cost: 196-204 T-states, 14 bytes
mulu_z80:
    ld   a, 0           ; 7T   clear accumulator
    ld   d, 8           ; 7T   8 bits

.loop:
    rr   c              ; 8T   shift multiplier bit into carry
    jr   nc, .noadd     ; 7/12T
    add  a, b           ; 4T   add multiplicand
.noadd:
    rra                 ; 4T   shift result right
    dec  d              ; 4T
    jr   nz, .loop      ; 12T
    ret                 ; 10T  ~200 T-states total
```

На eZ80:

```z80
; eZ80: 8x8 unsigned multiply (B * C -> BC)
; Cost: 6 cycles, 2 bytes
    mlt  bc             ; BC = B * C. Done.
```

Шесть тактов. Два байта. Никакого цикла, никакого управления переносом, никаких временных регистров. Результат попадает в полную 16-битную регистровую пару: старший байт произведения --- в B, младший --- в C.

### Что даёт MLT

**Индексация таблицы синусов.** Вычисление `base + angle * stride` для синусовых таблиц с переменным шагом сокращается с вызова подпрограммы до двух инструкций (`MLT` + `ADD`).

**Вычисление смещения спрайта.** Нахождение адреса кадра спрайта N в спрайтовом листе: `base + frame * frame_size`. С MLT это тривиально, когда frame_size помещается в 8 бит.

**Арифметика с фиксированной точкой.** Умножение двух 8-битных значений с фиксированной точкой (например, скорость * трение) становится одной инструкцией вместо цикла на 200 тактов.

**Адресация тайловой карты.** Вычисление `tile_base + (row * width + col)`, где width помещается в 8 бит: один MLT для смещения строки, один ADD для столбца.

### Ограничения MLT

- **Только беззнаковое.** Для знакового умножения нужно вручную скорректировать знак после MLT.
- **Только 8x8.** Для умножения 16x16 по-прежнему нужен многошаговый алгоритм (хотя его можно строить из компонентов MLT).
- **Результат перезаписывает оба операнда.** `MLT BC` уничтожает и B, и C, заменяя их 16-битным произведением. Сохрани входные значения заранее, если они тебе нужны.

---

## 5. Сводка ключевых различий

| Характеристика | Z80 (ZX Spectrum 128K) | eZ80 (Agon Light 2) |
|---------|----------------------|----------------------|
| Тактовая частота | 3,5 МГц | 18,432 МГц |
| Ширина адреса | 16-бит (64 КБ видимых) | 24-бит (16 МБ, 512 КБ заполнено) |
| Ширина регистров | 16-бит | 16-бит (режим Z80) или 24-бит (режим ADL) |
| Стек на PUSH/CALL | 2 байта | 2 байта (режим Z80) или 3 байта (режим ADL) |
| Инструкция умножения | Нет (цикл сдвигов и сложений, ~200T) | MLT rr (6 тактов) |
| ОЗУ | 128 КБ с переключением банков (8 x 16 КБ страниц) | 512 КБ непрерывное |
| Модель доступа к ОЗУ | Переключение банков через порт $7FFD | Плоская 24-битная адресация |
| Видео | ULA: прямое отображение в память по адресу $4000 | VDP (ESP32): командный протокол через UART |
| Звук | AY-3-8910 через порты ввода-вывода | VDP-аудио через последовательные команды |
| Прерывания | IM1 (RST $38) или IM2 (таблица векторов) | IM2 с векторами, управляемыми MOS |
| Бюджет кадра (50 Гц) | ~71 680 тактов (Pentagon) | ~368 640 тактов |
| Спорная память | Да (ULA крадёт такты у $4000-$7FFF) | Нет спорной памяти |
| ОС | Нет (голое железо) | MOS (Machine Operating System) |
| Хранение | Лента / DivMMC | SD-карта (FAT32, файловый API MOS) |

---

## 6. Особенности Agon Light 2

### Аппаратная часть

- **CPU:** Zilog eZ80F92, 18,432 МГц
- **ОЗУ:** 512 КБ внешнего SRAM, плоское адресное пространство
- **VDP:** ESP32-PICO-D4 с FabGL, связь с eZ80 через UART на скорости 1 152 000 бод
- **Видеорежимы:** Несколько, до 640x480x64 цвета. Большинство игр используют 320x240 или 320x200.
- **Аппаратные спрайты:** До 256, полностью управляются VDP
- **Аппаратные тайловые карты:** Прокручиваемые тайловые слои, управляются VDP
- **Аудио:** Синтез VDP --- синус, прямоугольник, треугольник, пилообразный, шум. ADSR-огибающие для каждого канала.
- **Хранение:** MicroSD-карта, FAT32, доступ через файловый API MOS

### Бюджет кадра

При 18,432 МГц и частоте обновления 50 Гц:

```
18,432,000 cycles/sec / 50 frames/sec = 368,640 cycles/frame
```

Для сравнения --- Pentagon (3,5 МГц, 50 Гц): 71 680 тактов на кадр. Agon располагает примерно **5,1-кратным** бюджетом кадра. Но поскольку многие инструкции eZ80 также выполняются за меньшее число тактов, чем их Z80-аналоги, эффективная пропускная способность для типичного кода в 5--20 раз выше.

### API MOS

MOS (Machine Operating System) предоставляет системный интерфейс. Стандартная точка входа --- `RST $08`:

```z80
; MOS API call pattern (in ADL mode)
    ld   a, mos_function     ; function number in A
    rst  $08                 ; call MOS
    ; return value in A (and sometimes HL)
```

Ключевые функции API MOS:

| Функция | Номер | Описание |
|----------|--------|-------------|
| `mos_getkey` | $00 | Ожидание нажатия клавиши, возвращает ASCII-код |
| `mos_load` | $01 | Загрузка файла с SD-карты в память |
| `mos_save` | $02 | Сохранение области памяти в файл на SD-карте |
| `mos_cd` | $03 | Смена текущего каталога |
| `mos_dir` | $04 | Вывод содержимого каталога |
| `mos_del` | $05 | Удаление файла |
| `mos_ren` | $06 | Переименование файла |
| `mos_sysvars` | $08 | Получение указателя на системные переменные (карта клавиатуры, состояние VDP, часы) |
| `mos_fopen` | $0A | Открытие файла, возвращает дескриптор |
| `mos_fclose` | $0B | Закрытие дескриптора файла |
| `mos_fread` | $0C | Чтение байтов из файла |
| `mos_fwrite` | $0D | Запись байтов в файл |
| `mos_fseek` | $0E | Перемещение позиции в файле |

### Протокол команд VDP

Команды VDP отправляются потоком байтов через `RST $10` (MOS: вывод байта в VDP). Большинство команд начинаются с VDU 23, за которым следуют параметры, специфичные для команды:

```z80
; Send one byte to VDP
    ld   a, byte_value
    rst  $10                 ; MOS: send byte to VDP

; Example: set screen mode
    ld   a, 22               ; VDU 22 = set mode
    rst  $10
    ld   a, mode_number      ; 0-3 for standard modes
    rst  $10

; Example: move hardware sprite
; VDU 23, 27, 4, spriteNum          -- select sprite
; VDU 23, 27, 13, x.lo, x.hi, y.lo, y.hi  -- set position
```

VDP обрабатывает команды асинхронно. Между отправкой команды и её выполнением VDP существует задержка последовательной передачи. Для плавной анимации отправляй все обновления в начале кадра.

---

## 7. Чек-лист портирования

При портировании кода Z80 со Spectrum на eZ80 в режиме ADL на Agon пройдись по этому чек-листу:

**Адреса и указатели:**
- Все адреса становятся 24-битными (3 байта вместо 2)
- Замени `DW` (define word) на `DL` (define long) для таблиц адресов
- Индексация таблиц указателей меняется с `* 2` на `* 3`
- Убедись, что старший байт 24-битных адресов корректен (обычно $00 или $04)

**Стековые кадры:**
- Каждый PUSH --- 3 байта, каждый CALL помещает 3-байтный адрес возврата
- Проверь, что пары PUSH/POP сбалансированы --- несовпадение пары разрушает 3 байта, а не 2
- Смещения относительно стека (например, доступ к параметрам, помещённым вызывающей стороной) изменяются

**Блочные операции:**
- `LDIR` / `LDDR` используют 24-битный BC в режиме ADL --- убедись, что старший байт BC равен нулю, если твой счётчик помещается в 16 бит
- Трюки с блочным копированием через `PUSH`/`POP` помещают 3 байта за PUSH, а не 2

**Умножение:**
- Замени циклы умножения сдвигом и сложением на `MLT` там, где это применимо
- `MLT BC` = B * C -> BC, `MLT DE` = D * E -> DE, `MLT HL` = H * L -> HL

**Ввод-вывод и периферия:**
- Замени портовый ввод-вывод (`OUT (C), A`, `IN A, ($FE)`) на вызовы API MOS/VDP
- Замени прямую запись в видеобуфер ($4000--$5AFF) командами VDP
- Замени запись регистров AY ($FFFD/$BFFD) звуковыми командами VDP

**Архитектура памяти:**
- Удали всю логику переключения банков (запись в порт $7FFD) --- плоское адресное пространство
- Удали обходные пути для спорной памяти --- на Agon нет спорной памяти
- Удали трюки с теневым экраном --- VDP сам управляет двойной буферизацией

**Паттерны кода, которые становятся ненужными:**
- Самомодифицирующийся код для скорости (по-прежнему работает, редко стоит усложнения)
- Трюки с указателем стека для быстрой заливки экрана (нет видеобуфера для заливки)
- Предсмещённые спрайтовые копии (аппаратные спрайты поддерживают субпиксельное позиционирование)
- Вычисления чересстрочных адресов экрана (DOWN_HL, pixel_addr --- удаляй)

**Паттерны кода, которые переносятся напрямую:**
- Циклы системы сущностей (просто расширь указатели)
- AABB-обнаружение столкновений (8-битные сравнения, без изменений)
- Арифметика с фиксированной точкой 8.8 (побайтовая, без изменений)
- Конечные автоматы и таблицы переходов (расширь элементы таблицы до 24 бит)
- Циклы DJNZ, поиск CPIR, ветвление по флагам (всё идентично)

---

## См. также

- **Приложение A: Краткий справочник инструкций Z80** --- полная таблица инструкций Z80 с тактами, размерами в байтах и влиянием на флаги. Всё из Приложения A также применимо к eZ80 в Z80-совместимом режиме.
- **Глава 22: Портирование --- Agon Light 2** --- полное пошаговое руководство по портированию с примерами кода «до» и «после» для рендеринга, звука, ввода и игровой логики.

---

> **Источники:** Zilog eZ80 CPU User Manual (UM0077); Zilog eZ80F92 Product Specification (PS0153); Agon Light 2 Official Documentation, The Byte Attic; Dean Belfield, "Agon Light --- Programming Guide" (breakintoprogram.co.uk); Agon MOS API Documentation (github.com/AgonConsole8/agon-docs); Глава 22 этой книги
