# Приложение F: Варианты Z80 --- Расширенные наборы инструкций

> *«Тот же набор инструкций, совершенно другая машина.»*
> -- Глава 22

Zilog Z80 не застыл в 1976 году. За пять десятилетий оригинальную конструкцию клонировали, расширяли, переосмысливали и --- в случае ZX Spectrum Next --- перестроили те самые люди, которые тридцать лет проклинали его ограничения. Это приложение обозревает основные варианты Z80 и расширения их наборов инструкций с фокусом на том, что важно для демосцены и игровых программистов. Стандартный набор инструкций Z80 рассмотрен в Приложении A; eZ80 подробно описан в Приложении E. Это приложение даёт общую картину --- как варианты соотносятся друг с другом, что каждый из них добавляет и почему.

---

## 1. Генеалогическое древо Z80

Z80 был спроектирован Федерико Фаджином и Масатоси Симой в Zilog в 1976 году как программно-совместимый наследник Intel 8080. Он стал самым распространённым 8-битным процессором в истории, оживляя всё --- от деловых машин на CP/M до аркадных автоматов и целого поколения домашних компьютеров. Набор инструкций был зафиксирован при выпуске и никогда официально не расширялся Zilog --- до появления eZ80, два десятилетия спустя.

Но другие его расширяли. Вот семейство в общих чертах:

| Вариант | Год | Примечательная машина | Ключевое добавление |
|---------|------|----------------|--------------|
| Z80 (Zilog) | 1976 | ZX Spectrum, MSX, Amstrad CPC | Оригинал. 158 документированных инструкций. |
| КР1858ВМ1 (СССР) | ~1986 | Pentagon, Scorpion | Точный клон. Никаких изменений инструкций. |
| NSC800 (National Semi) | 1980 | Различные встраиваемые системы | CMOS Z80 с шиной в стиле 8085. Новых инструкций нет. |
| R800 (ASCII Corp) | 1990 | MSX turboR | Z80-совместимый, радикально иной конвейер. MULUB, MULUW. |
| eZ80 (Zilog) | 2001 | Agon Light 2 | 24-битная адресация, MLT, LEA, PEA, режим ADL. |
| Z80N (команда Next) | 2017 | ZX Spectrum Next | Список желаний демосцены: MUL, MIRROR, LDIRX, PIXELDN, циклические сдвиги. |

Z80 и его клоны имеют идентичный набор инструкций. R800, eZ80 и Z80N добавили инструкции для решения конкретных проблем --- но очень разных проблем, отражающих очень разные цели проектирования.

---

## 2. Z80N --- Список желаний демосценера

Z80N --- это процессор в ZX Spectrum Next. Его спроектировали Виктор Трукко, Фабиу Белавенуту и команда Next --- люди, которые десятилетиями писали код для Z80 и точно знали, где больно. Каждая новая инструкция решает конкретную, хорошо задокументированную проблему из тридцатилетнего опыта программирования Spectrum. Z80N работает на 28 МГц (8-кратная тактовая частота оригинального Spectrum) и добавляет примерно 40 новых инструкций, все закодированные в ранее неиспользуемом пространстве опкодов `$ED xx`.

Лучший способ понять расширения Z80N --- посмотреть, какую проблему решает каждая инструкция.

### Навигация по экрану (проблема DOWN_HL)

На стандартном Spectrum вычисление экранного адреса по координатам пикселя занимает 50--60 тактов и страницу кода (см. `pixel_addr` в Приложении A). Перемещение на одну строку пикселей вниз требует печально известной подпрограммы `DOWN_HL` --- условного лабиринта из INC, AND, ADD и SUB, обрабатывающего границы знакорядов и третей. Z80N заменяет всё это одиночными инструкциями.

| Инструкция | Байт | T | Что заменяет |
|-------------|-------|---|------------------|
| `PIXELDN` | 2 | 8 | Последовательность `DOWN_HL` из 10+ инструкций (проверка границы трети, обработка переноса, корректировка H и L). Перемещает HL на одну строку пикселей вниз в экранной памяти. |
| `PIXELAD` | 2 | 8 | Полное вычисление экранного адреса по координатам (D,E). Заменяет подпрограмму `pixel_addr` (~55T, 15+ инструкций). |
| `SETAE` | 2 | 8 | Устанавливает соответствующий пиксельный бит в A на основе младших 3 бит E (x-координата). Заменяет таблицу подстановки или последовательность сдвигов. |

С этими тремя инструкциями вся последовательность вывода пикселя, которая на оригинальном Z80 потребляла 70+ тактов и 20+ байтов, становится:

```z80
; Z80N: plot pixel at (D=y, E=x) — 23T total
    pixelad             ; 8T  HL = screen address from (D,E)
    setae               ; 8T  A = pixel bit mask from E
    or   (hl)           ; 7T  set pixel (non-destructive)
    ; ... ld (hl), a to write
```

### Рендеринг спрайтов (проблема маскированного блита)

Самая CPU-затратная операция в любой игре или демо для Spectrum --- маскированный блит спрайта: копирование прямоугольного блока спрайтовых данных в экранную память с пропуском прозрачных пикселей. На стандартном Z80 для этого нужен внутренний цикл из LD/AND/OR/LD на каждый байт, обычно 30--40 тактов на пиксельный байт. Z80N добавляет инструкции блочного копирования со встроенной прозрачностью.

| Инструкция | Байт | T | Что заменяет |
|-------------|-------|---|------------------|
| `LDIX` | 2 | 16 | `LDI`, но пропускает копирование, если `(HL) == A`. Однокомандное прозрачное копирование: загрузи в A прозрачный цвет, настрой HL на источник, DE на приёмник --- и каждый байт копируется только если он не равен прозрачному значению. |
| `LDDX` | 2 | 16 | То же, что LDIX, но с декрементом (как `LDD`). |
| `LDIRX` | 2 | 21/16 | Повторяющийся LDIX. Аппаратный маскированный блит спрайта одной инструкцией. Копирует BC байтов из (HL) в (DE), пропуская любой байт, равный A. 21T на байт при BC>0, 16T на последней итерации. |
| `LDDRX` | 2 | 21/16 | Повторяющийся LDDX. |
| `LDPIRX` | 2 | 21/16 | Заливка паттерном с прозрачностью из 8-байтового выровненного источника. Читает по адресу `(HL & $FFF8) + (E & 7)`, копирует в (DE) если не равно A, инкрементирует DE, декрементирует BC. Аппаратный рендерер тайлового фона. 21T на байт при BC>0, 16T на последней итерации. |

Одна `LDIRX` заменяет самый тщательно оптимизированный внутренний цикл за десятилетия Spectrum-геймдева. `LDPIRX` ещё экзотичнее --- она трактует источник как повторяющийся 8-байтовый паттерн, фактически предоставляя аппаратный тайловый рендерер с прозрачностью. В сочетании с Layer 2 и тайловым оборудованием Next эти инструкции делают ZX Spectrum Next качественно другой платформой для спрайтовых игр.

### Арифметика (проблема умножения)

У Z80 нет инструкции умножения. Каждое умножение в коде для Spectrum --- это цикл сдвигов и сложений стоимостью 150--250 тактов (см. `mulu112` в Приложении A). Z80N решает это одной инструкцией.

| Инструкция | Байт | T | Что заменяет |
|-------------|-------|---|------------------|
| `MUL D,E` | 2 | 8 | Беззнаковое умножение 8x8, результат в DE. Заменяет цикл сдвигов и сложений на ~200T. |

Восемь тактов. На 28 МГц это 286 наносекунд. Та же операция на стандартном Spectrum с 3,5 МГц занимает примерно 57 микросекунд --- улучшение в 200 раз с учётом и более быстрого тактирования, и более быстрой инструкции. Матрицы вращения, преобразования координат, текстурирование, проекция перспективы --- всё, что требует умножения, фундаментально дешевле на Z80N.

### Битовые манипуляции

| Инструкция | Байт | T | Что заменяет |
|-------------|-------|---|------------------|
| `MIRROR` | 2 | 8 | Реверсирует все 8 бит A. Горизонтальный переворот спрайта без 256-байтовой таблицы подстановки. На стандартном Z80 реверс битов A требует либо развёрнутой последовательности из 18 инструкций (`LD B,A : XOR A` затем 8x `RR B : RLA`, ~104T), либо 256-байтовой таблицы подстановки (11T, но стоит 256 байтов ОЗУ). |
| `SWAPNIB` | 2 | 8 | Меняет местами старший и младший ниббл A. Заменяет `RLCA : RLCA : RLCA : RLCA` (16T, 4 байта). |
| `TEST nn` | 3 | 11 | `AND A, nn` без сохранения результата --- устанавливает флаги, но сохраняет A. Как CP для побитового AND. Аналог инструкции TST на eZ80. |

`MIRROR` особенно ценна для игр. Без неё каждый горизонтально отражённый спрайт требует либо предварительно отражённой копии в памяти (удвоение спрайтовых данных), либо 256-байтовой таблицы реверса битов плюс побайтовые обращения к таблице. С ней можно отражать спрайты на лету по 8T за байт.

### Циклические сдвиги (проблема многобитного сдвига)

На стандартном Z80 сдвиг 16-битного значения более чем на один бит требует цикла: `SLA E : RL D` на каждый бит, 16T на позицию. Сдвиг DE влево на 5 бит стоит 80T. Z80N добавляет инструкции циклического сдвига, которые сдвигают DE на произвольное число позиций (заданное в B) за постоянное время.

| Инструкция | Байт | T | Что заменяет |
|-------------|-------|---|------------------|
| `BSLA DE,B` | 2 | 8 | Сдвиг DE влево на B бит. Заменяет `B * (SLA E : RL D)`. |
| `BSRA DE,B` | 2 | 8 | Арифметический сдвиг DE вправо на B бит (с расширением знака). |
| `BSRL DE,B` | 2 | 8 | Логический сдвиг DE вправо на B бит (заполнение нулями). |
| `BSRF DE,B` | 2 | 8 | Сдвиг DE вправо на B бит с заполнением битом 15. |
| `BRLC DE,B` | 2 | 8 | Циклический сдвиг DE влево на B бит. |

Они невероятно полезны в арифметике с фиксированной точкой, субпиксельном позиционировании и любом коде, преобразующем между целочисленными масштабами. Типичная операция вроде «умножить на 5 и сдвинуть вправо на 3», которая на стандартном Z80 заняла бы ~50T, становится тривиальной.

### Удобные инструкции

| Инструкция | Байт | T | Что заменяет |
|-------------|-------|---|------------------|
| `PUSH nn` | 4 | 23 | Помещает 16-битное непосредственное значение в стек. Регистр не нужен. Экономит паттерн `LD rr, nn : PUSH rr` (21T, 4 байта на оригинальном Z80 --- тот же размер, на 2T *медленнее*, но не затрагивает регистровую пару). Когда регистровая пара уже занята, PUSH nn экономит пару PUSH/POP вокруг LD+PUSH, что более чем компенсирует разницу. |
| `ADD HL,A` | 2 | 8 | Прибавить A к HL. Заменяет последовательность из 5 инструкций на 23T: `ADD A,L : LD L,A : ADC A,H : SUB L : LD H,A` (или аналогичную через запасной регистр). |
| `ADD DE,A` | 2 | 8 | То же, что ADD HL,A, но для DE. |
| `ADD BC,A` | 2 | 8 | То же для BC. |
| `NEXTREG reg,val` | 4 | 20 | Прямая запись в аппаратный регистр Next. Не нужна настройка портов ввода-вывода. Заменяет `LD BC,$243B : OUT (C),reg : LD BC,$253B : OUT (C),val` --- четыре инструкции, 8 байтов, ~48T. |
| `NEXTREG reg,A` | 3 | 17 | Записать A в аппаратный регистр Next. |
| `OUTINB` | 2 | 16 | `OUT (C),(HL) : INC HL` в одной инструкции. Полезна для потоковой передачи данных в порты ввода-вывода. |

### Общая картина

Z80N --- это, по сути, тридцать лет демосценерского разочарования, отлитого в кремнии. Каждая инструкция --- это шрам от конкретной, хорошо задокументированной проблемы:

- `PIXELDN` существует потому, что каждый программист Spectrum хотя бы раз написал `DOWN_HL`, хотя бы дважды отлаживал случай с границей трети и мечтал больше этого не делать.
- `MIRROR` существует потому, что каждый игровой программист потратил 256 байтов на таблицу реверса битов для горизонтального отражения спрайтов.
- `LDIRX` существует потому, что внутренний цикл маскированного блита --- это то, на что большинство игр для Spectrum тратят основную часть процессорного времени.
- `MUL D,E` существует потому, что цикл умножения сдвигом и сложением --- самая часто переписываемая подпрограмма в истории Z80.

В отличие от eZ80 (разработанного Zilog для встраиваемых рынков) или R800 (разработанного ASCII Corporation для платформы MSX), Z80N был спроектирован сообществом для сообщества. Набор инструкций читается как список желаний демосцены, потому что он *и есть* список желаний демосцены --- команда Next собирала отзывы от действующих кодеров Spectrum и приоритизировала инструкции, которые снимут максимум боли с наиболее частых операций.

---

## 3. eZ80 --- Корпоративное расширение

eZ80 --- это официальный наследник Z80 от Zilog, разработанный для встраиваемых систем, которым нужно больше 64 КБ адресного пространства. Это строгое надмножество Z80 --- каждый опкод Z80 допустим и ведёт себя идентично. Расширения скорее архитектурные, чем вычислительные:

- **24-битная адресация и режим ADL.** Регистры могут быть 16-битными или 24-битными в зависимости от рабочего режима. Режим ADL (Address Data Long) даёт 24-битные регистры и плоское адресное пространство на 16 МБ. Z80-совместимый режим ведёт себя точно как стандартный Z80, а регистр MBASE предоставляет недостающие старшие 8 бит адреса.

- **MLT rr --- беззнаковое умножение 8x8.** `MLT BC` умножает B на C и сохраняет 16-битный результат в BC. Аналогично для `MLT DE` (D * E -> DE) и `MLT HL` (H * L -> HL). Это гибче, чем `MUL D,E` на Z80N, который работает только с DE. eZ80 даёт три независимых «умножителя». За 6 тактов на eZ80 (работающем на 18,432 МГц на Agon) это молниеносно быстро.

- **LEA и PEA.** Load Effective Address и Push Effective Address --- инструкции вычисления индексированного адреса. `LEA rr, IX+d` загружает вычисленный адрес в регистровую пару без обращения к памяти. `PEA IX+d` помещает вычисленный адрес в стек. Полезны для передачи параметров и арифметики указателей.

- **TST (тест) и TSTIO.** Неразрушающий тест AND, аналогичный инструкции `TEST nn` на Z80N. `TSTIO` проверяет значение порта ввода-вывода по маске.

- **IN0/OUT0.** Доступ к внутреннему периферийному пространству (адреса $00--$FF).

eZ80 проектировался для промышленного управления, сетевого оборудования и принтеров --- не для ретрокомпьютинга. Но он оказался в Agon Light 2, и внезапно процессор, спроектированный для встраиваемых рынков, стал ретро-игровой платформой. Полный справочник по eZ80 --- в Приложении E; история портирования --- в Главе 22.

---

## 4. R800 --- Скоростной монстр MSX turboR

R800 --- самый странный член семейства. Разработанный ASCII Corporation для MSX turboR (1990, Panasonic FS-A1GT/FS-A1ST), он Z80-совместим в том смысле, что выполняет полный набор инструкций Z80 --- но его внутренняя архитектура радикально отличается.

**Конвейер, а не микрокод.** Оригинальный Z80 --- микрокодовый: каждая инструкция разбивается на машинные циклы (M-циклы) по 3--6 тактов, и сложные инструкции занимают много M-циклов. R800 использует конвейерную архитектуру, где большинство инструкций выполняется за 1--2 тактовых цикла. На 7,16 МГц это даёт эффективную пропускную способность примерно в 5--8 раз выше, чем у Z80 на 3,5 МГц для типичного кода.

**Аппаратное умножение.** R800 добавляет две инструкции умножения:

| Инструкция | Операнды | Результат | Тактов | Примечания |
|-------------|----------|--------|--------|-------|
| `MULUB A,r` | A * r (8-бит, без знака) | HL = 16-битное произведение | 14 | r = B, C, D, E |
| `MULUW HL,rr` | HL * rr (16-бит, без знака) | DE:HL = 32-битное произведение | 36 | rr = BC, SP |

Умножение 16x16 с 32-битным результатом за 36 тактов --- это впечатляет для процессора эпохи 8 бит. На стандартном Z80 умножение 16x16 занимает 600--1000 тактов в зависимости от реализации. R800 делает 3D-преобразования, DSP-фильтрацию и другие алгоритмы с интенсивным умножением по-настоящему практичными.

**Ловушка конвейера.** Код, оптимизированный под тайминги Z80, может вести себя неожиданно на R800. Z80-трюк с развёрткой `LDIR` в отдельные `LDI` (экономящий 5T на байт) на самом деле работает *медленнее* на R800, потому что конвейер R800 эффективно обрабатывает префикс повтора `LDIR`. Аналогично, самомодифицирующийся код --- фирменный приём демосцены на Z80 --- может застопорить конвейер R800, когда запись попадает в предвыбранную инструкцию. Код, быстрый на Z80, не обязательно быстр на R800, и наоборот.

**Присутствие на демосцене.** У MSX turboR крошечная, но преданная демосцена. Аппаратное умножение делает 3D в реальном времени осуществимым, а чистая скорость позволяет эффекты, невозможные на тактовых частотах Z80. Но редкость платформы (продавалась только в Японии, малая серия) означает, что R800 остаётся сноской в более широкой истории Z80.

---

## 5. Советские клоны --- За железным занавесом

Советский Союз производил несколько клонов Z80, чтобы обойти западные экспортные ограничения. Эти микросхемы породили целую экосистему ZX Spectrum-совместимых компьютеров, расцветшую с конца 1980-х по 1990-е --- и чья демосцена остаётся активной по сей день.

**КР1858ВМ1**. Основной советский клон Z80. Совместим по выводам, по инструкциям, по ошибкам. Производился на заводе «Ангстрем» в Зеленограде по реверс-инженерным маскам. КР1858ВМ1 стоял в основе Pentagon 128 и Scorpion ZS-256 --- двух важнейших советских клонов Spectrum и платформ, под которые значительная часть современной российской/СНГ демосцены ZX по-прежнему создаёт свои работы.

**Т34ВМ1**. Более поздняя CMOS-версия того же дизайна, с меньшим энергопотреблением и слегка отличающимися электрическими характеристиками. Функционально идентичен КР1858ВМ1.

Ни один из этих чипов не добавляет новых инструкций. Они являются точными функциональными репликами Zilog Z80. Различия электрические: разные технологические процессы, разные временные допуски на установку и удержание, слегка отличающееся поведение на недокументированных опкодах и битах флагов. Для программных целей код, работающий на Zilog Z80, работает идентично на КР1858ВМ1.

Историческое значение огромно. Без этих клонов экосистема ZX Spectrum не распространилась бы по Советскому Союзу и его государствам-преемникам. Pentagon 128, построенный на КР1858ВМ1, стал *де-факто* стандартной платформой Spectrum в России, и его тайминги без спорной памяти (без задержек из-за ULA) --- это эталонные тайминги, используемые в этой книге.

---

## 6. Сравнительная таблица

| Характеристика | Z80 | Z80N | eZ80 | R800 |
|---------|-----|------|------|------|
| Тактовая частота (типичная) | 3,5 МГц | 28 МГц | 18,4 МГц | 7,16 МГц |
| Адресное пространство | 64 КБ | 64 КБ + регистры Next | 16 МБ | 64 КБ |
| Аппаратное умножение | Нет | `MUL D,E` (8T) | `MLT rr` (6T) | `MULUB` (14T), `MULUW` (36T) |
| Умножение 16x16 | Нет | Нет | Нет | `MULUW` (36T, 32-битный результат) |
| Циклический сдвиг | Нет | `BSLA/BSRA/BSRL/BSRF/BRLC DE,B` (8T) | Нет | Нет |
| Блочное копирование с маской | Нет | `LDIRX`, `LDPIRX` | Нет | Нет |
| Помощники экранного адреса | Нет | `PIXELDN`, `PIXELAD`, `SETAE` | Нет | Нет |
| Реверс битов | Нет | `MIRROR` (8T) | Нет | Нет |
| Обмен ниббл | Нет | `SWAPNIB` (8T) | Нет | Нет |
| 24-битный режим | Нет | Нет | Режим ADL | Нет |
| Push непосредственного значения | Нет | `PUSH nn` (23T) | Нет | Нет |
| Сложение 8-бит с 16-бит | Нет | `ADD HL/DE/BC, A` (8T) | Нет | Нет |
| Тест (неразрушающий AND) | Нет | `TEST nn` (11T) | `TST` (7T) | Нет |
| Аппаратный регистровый ввод-вывод | Нет | `NEXTREG` (17-20T) | `IN0`/`OUT0` | Нет |
| Разработан для | Общего назначения | ZX Spectrum Next | Встраиваемых систем | MSX turboR |

### Эффективная производительность умножения

Поскольку все четыре варианта работают на разных тактовых частотах, количество тактов само по себе не даёт полной картины. Вот реальное время выполнения беззнакового умножения 8x8 на каждой платформе:

| Вариант | Частота | Инструкция | Тактов | Реальное время |
|---------|-------|-------------|--------|-----------------|
| Z80 | 3,5 МГц | Цикл сдвигов и сложений | ~200 | ~57 мкс |
| Z80N | 28 МГц | `MUL D,E` | 8 | ~0,29 мкс |
| eZ80 | 18,4 МГц | `MLT DE` | 6 | ~0,33 мкс |
| R800 | 7,16 МГц | `MULUB A,r` | 14 | ~1,96 мкс |

Z80N и eZ80 по производительности умножения фактически одинаковы. R800 в 30 раз быстрее стандартного Z80, но в 6--7 раз медленнее Z80N/eZ80. Все три достаточно быстры, чтобы сделать 3D в реальном времени практичным.

---

## 7. Что это значит для книги

Весь ассемблерный код в этой книге написан для **стандартного набора инструкций Z80**. Каждый пример в каждой главе ассемблируется и запускается на обычном ZX Spectrum 48K, Pentagon 128, Scorpion, MSX или любой другой машине с Zilog Z80 или совместимым клоном. Никаких расширений не требуется.

Это осознанный выбор. Принципы оптимизации --- бюджет тактов, распределение регистров, структура циклов, самомодифицирующийся код, развёрнутые циклы, трюки со стеком --- универсальны. Код, быстрый на Z80 с 3,5 МГц, быстр и на Z80N с 28 МГц. Код, помещающийся в 48 КБ, помещается и в 16 МБ. Ограничения оригинального Z80 учат тебя мыслить так, что это переносится на каждый вариант семейства.

Тем не менее, если у тебя есть ZX Spectrum Next, расширения Z80N слишком хороши, чтобы их игнорировать. Глава 22 охватывает стратегии портирования, включая Z80N-специфичные оптимизации. Если у тебя Agon Light 2, Приложение E --- твой справочник по eZ80, а Глава 22 проведёт через полный порт со Spectrum на Agon. Циклические сдвиги, аппаратное умножение и инструкции маскированного блита не меняют *как* ты думаешь об оптимизации --- они меняют *где переместится узкое место*, когда классические болевые точки будут устранены.

Фундаментальные принципы не меняются. Инструкции становятся лучше.

---

## См. также

- **Приложение A: Краткий справочник инструкций Z80** --- полная таблица стандартных инструкций Z80 с тактами, размерами в байтах и влиянием на флаги. Базовая линия, общая для всех вариантов.
- **Приложение E: Краткий справочник по eZ80** --- полный справочник по eZ80, включая систему режимов, MLT, LEA/PEA и особенности Agon Light 2.
- **Глава 22: Портирование --- Agon Light 2** --- практическое пошаговое руководство по портированию, охватывающее расширения eZ80 и Z80N в контексте.

---

> **Примечание по аудиту тактов:** Значения тактов Z80N в этом приложении были исправлены по официальной документации на wiki.specnext.dev. Изначальные значения (приблизительно заниженные вдвое по всем позициям) были выявлены как некорректные Ped7g (Петер Хелцмановски).

> **Источники:** Zilog Z80 CPU User Manual (UM0080); Zilog eZ80 CPU User Manual (UM0077); ZX Spectrum Next User Manual, Issue 2; ZX Spectrum Next Extended Instruction Set Documentation (wiki.specnext.dev); Victor Trucco, Fabio Belavenuto et al., Z80N instruction set design notes; ASCII Corporation R800 Technical Reference (1990); Sean Young, "The Undocumented Z80 Documented" (2005); Introspec, "Once more about DOWN_HL" (Hype, 2020); Dark / X-Trade, "Programming Algorithms" (Spectrum Expert #01, 1997)
