# Глава 11: Звуковая архитектура -- AY, TurboSound и Triple AY

> *"У чипа AY три голоса. Это не ограничение -- это конструктивное решение, сформировавшее целый музыкальный жанр."*

---

AY-3-8912 -- голос ZX Spectrum 128K. General Instrument спроектировала семейство AY-3-8910 в 1978 году как программируемый генератор звука (PSG, Programmable Sound Generator) -- единственный чип, способный воспроизводить музыку и звуковые эффекты, не загружая процессор генерацией звука. Investronica первой установила AY в испанский Spectrum 128K, Sinclair переняла это решение, а к моменту, когда Amstrad унаследовала его для +2/+3, чип уже был проверенной рабочей лошадкой: Intellivision, MSX, Atari ST и десятки аркадных автоматов использовали его или его pin-совместимые варианты (YM2149 в Atari ST). В Spectrum 128K используется именно AY-3-8912, у которого меньше портов ввода-вывода, чем у 8910, но звуковые возможности полностью идентичны.

Четырнадцать регистров. Три канала прямоугольной волны. Один генератор шума. Один генератор огибающей. Это всё, что ты получаешь. Всё, что ты когда-либо слышал в чиптюне для Spectrum 128K -- качающие басовые линии, стремительные арпеджированные аккорды, резкие барабаны -- создаётся программированием этих четырнадцати регистров пятьдесят раз в секунду.

Эта глава проведёт тебя от голых записей в регистры до работающего музыкального движка. К её концу ты будешь точно понимать, как проигрыватель трекера передаёт звук в AY, и будешь обладать знаниями, чтобы написать свой собственный.

---

## 11.1 Карта регистров AY-3-8910

AY имеет 14 регистров, адресуемых R0--R13. На ZX Spectrum 128K доступ к ним осуществляется через два порта ввода-вывода:

- **$FFFD** -- выбор регистра (сначала записываешь сюда номер регистра)
- **$BFFD** -- запись данных (затем записываешь сюда значение)

Всегда сначала выбирай регистр, затем записывай данные. Этот двухшаговый процесс фундаментален:

```z80 id:ch11_the_ay_3_8910_register_map
; Write value E to AY register A
ay_write:
    ld   bc, $FFFD
    out  (c), a       ; select register
    ld   b, $BF       ; $BFFD high byte (C stays $FD)
    out  (c), e       ; write data
    ret
```

Обрати внимание на трюк: мы меняем только старший байт BC между двумя инструкциями OUT. Младший байт $FD остаётся в C на протяжении всего вызова. Это экономит повторную загрузку полного 16-битного значения.

### Полная таблица регистров

| Рег. | Название | Биты | Описание |
|------|----------|------|----------|
| R0  | Период тона A, младший | 8 | Младшие 8 бит периода тона канала A |
| R1  | Период тона A, старший | 4 | Старшие 4 бита периода тона канала A |
| R2  | Период тона B, младший | 8 | Младшие 8 бит периода тона канала B |
| R3  | Период тона B, старший | 4 | Старшие 4 бита периода тона канала B |
| R4  | Период тона C, младший | 8 | Младшие 8 бит периода тона канала C |
| R5  | Период тона C, старший | 4 | Старшие 4 бита периода тона канала C |
| R6  | Период шума | 5 | Период генератора шума (0-31) |
| R7  | Микшер / разрешение I/O | 8 | Разрешение тона и шума по каналам + I/O |
| R8  | Громкость A | 5 | Громкость канала A (0-15) или режим огибающей |
| R9  | Громкость B | 5 | Громкость канала B (0-15) или режим огибающей |
| R10 | Громкость C | 5 | Громкость канала C (0-15) или режим огибающей |
| R11 | Период огибающей, младший | 8 | Младшие 8 бит периода огибающей |
| R12 | Период огибающей, старший | 8 | Старшие 8 бит периода огибающей |
| R13 | Форма огибающей | 4 | Форма волны огибающей (0-15) |

<!-- figure: ch11_ay_registers -->
![AY-3-8910 register map](illustrations/output/ch11_ay_registers.png)

### Тональные каналы (R0-R5): как работает высота тона

Каждый из трёх тональных каналов генерирует прямоугольную волну. Частота контролируется 12-битным значением периода, разделённым на два регистра:

```text
Frequency = AY_clock / (16 x period)
```

На Spectrum 128K тактовая частота AY составляет 1,7734 МГц (половина тактовой частоты ЦП 3,5469 МГц). Так, для ноты до первой октавы (примерно 262 Гц):

```text
period = 1,773,400 / (16 x 262) = 423
```

12-битный период даёт диапазон от 1 (110 837 Гц -- неслышимый ультразвук) до 4095 (27 Гц -- глубокий басовый гул). Вот практическая таблица нот для октавы 4:

| Нота | Частота (Гц) | Период (дес.) | R_LO | R_HI |
|------|-------------|---------------|------|------|
| C4   | 261.6 | 424 | $A8 | $01 |
| C#4  | 277.2 | 400 | $90 | $01 |
| D4   | 293.7 | 378 | $7A | $01 |
| D#4  | 311.1 | 357 | $65 | $01 |
| E4   | 329.6 | 337 | $51 | $01 |
| F4   | 349.2 | 318 | $3E | $01 |
| F#4  | 370.0 | 300 | $2C | $01 |
| G4   | 392.0 | 283 | $1B | $01 |
| G#4  | 415.3 | 267 | $0B | $01 |
| A4   | 440.0 | 252 | $FC | $00 |
| A#4  | 466.2 | 238 | $EE | $00 |
| B4   | 493.9 | 225 | $E1 | $00 |
| C5   | 523.3 | 212 | $D4 | $00 |

Чтобы подняться на октаву, раздели период пополам. Чтобы опуститься -- удвой. Полная таблица нот для всех полезных октав находится в Приложении G.

### Генератор шума (R6)

Регистр R6 управляет единственным генератором шума, общим для всех трёх каналов. 5-битное значение (0-31) задаёт "высоту" шума -- меньшие значения дают более высокий шипящий шум; большие значения -- более низкий грубый шум. Генератор шума производит псевдослучайный выход с использованием 17-битного регистра сдвига с линейной обратной связью.

Полезные диапазоны:
- **0-5**: Высокий шип (хай-хэт, тарелка)
- **6-12**: Средний шум (тело малого барабана)
- **13-20**: Низкий рокот (взрыв)
- **21-31**: Очень низкий (ветер, гром)

### R7: Микшер -- самый важный регистр

Регистр R7 -- сердце AY. Шесть бит управляют тем, какие каналы получают тон, шум или и то, и другое. Ещё два бита управляют направлением портов ввода-вывода (не имеет значения для звука, оставляй их как входы = 1).

```text id:ch11_r7_the_mixer_the_most
Bit 7: I/O port B direction (1 = input)
Bit 6: I/O port A direction (1 = input)
Bit 5: Noise C enable (0 = ON, 1 = off)
Bit 4: Noise B enable (0 = ON, 1 = off)
Bit 3: Noise A enable (0 = ON, 1 = off)
Bit 2: Tone C enable  (0 = ON, 1 = off)
Bit 1: Tone B enable  (0 = ON, 1 = off)
Bit 0: Tone A enable  (0 = ON, 1 = off)
```

**Запутывающая часть: 0 означает ВКЛ.** На этом спотыкаются все при первом знакомстве. AY использует логику с активным низким уровнем для разрешений микшера. Сброшенный бит включает соответствующий источник.

Вот таблица полезных комбинаций микшера:

| Значение | Двоичное (NcNbNa TcTbTa) | Эффект |
|----------|--------------------------|--------|
| $38   | `111 000` | Все три тона включены, без шума |
| $3E   | `111 110` | Только тон A |
| $3D   | `111 101` | Только тон B |
| $3B   | `111 011` | Только тон C |
| $36   | `110 110` | Тон A + Шум A |
| $07   | `000 111` | Все три шума, без тонов |
| $30   | `110 000` | Тоны A+B+C, Шум A |
| $00   | `000 000` | Всё включено (какофония) |
| $3F   | `111 111` | Всё выключено (тишина) |

Типичный паттерн для музыки: тоны A+B для мелодии и гармонии, тон C + шум C для ударных:

```z80 id:ch11_r7_the_mixer_the_most_2
; Mixer: tone A on, tone B on, tone C on, noise C on
; Binary: 00 011 000 = noise C on (bit5=0) + all tones on (bits0-2=0)
;         noise A,B off (bits3,4=1), I/O bits=0
; = $18
ld   a, R_MIXER
ld   e, $18
call ay_write
```

### Регистры громкости (R8-R10)

Каждый канал имеет 4-битное управление громкостью (0-15, где 15 -- самая громкая). Но бит 4 особенный: его установка переключает канал в **режим огибающей**, где громкость контролируется автоматически генератором огибающей вместо фиксированного значения.

```text id:ch11_volume_registers_r8_r10
Bit 4: 1 = use envelope generator, 0 = use bits 3-0
Bits 3-0: Fixed volume level (0-15)
```

Кривая громкости логарифмическая на настоящем AY-3-8910 (каждый шаг составляет приблизительно 1,5 дБ), но варьируется между ревизиями чипа и клонами. YM2149 имеет другую кривую громкости, поэтому одна и та же мелодия звучит немного по-разному на Atari ST и на Spectrum.

### Генератор огибающей (R11-R13)

AY имеет один генератор огибающей -- общий для всех каналов, которые его используют. Он автоматически модулирует громкость согласно повторяющейся форме волны.

**R11-R12: Период огибающей** -- 16-битное значение, управляющее скоростью огибающей:

```text
Envelope_frequency = AY_clock / (256 x period)
```

При периоде = 1 огибающая циклится с частотой около 6 927 Гц. При периоде = 65535 она циклится примерно 0,11 Гц -- приблизительно один раз каждые 9 секунд.

**R13: Форма огибающей** -- четыре бита выбирают форму волны. Хотя 4 бита допускают 16 значений, уникальных форм только 10:

| Значение | Форма | Описание |
|----------|-------|----------|
| $00-$03 | `\___` | Однократное затухание, затем тишина. (Все четыре идентичны.) |
| $04-$07 | `/___` | Однократная атака, затем тишина. (Все четыре идентичны.) |
| $08 | `\\\\` | Повторяющаяся пила вниз. |
| $09 | `\___` | Однократное затухание, затем тишина. (То же, что $00.) |
| $0A | `\/\/` | Повторяющийся треугольник (затухание-атака). |
| $0B | `\'''` | Однократное затухание, затем удержание на максимуме. |
| $0C | `////` | Повторяющаяся пила вверх. |
| $0D | `/'''` | Однократная атака, затем удержание на максимуме. |
| $0E | `/\/\` | Повторяющийся треугольник (атака-затухание). |
| $0F | `/___` | Однократная атака, затем тишина. (То же, что $04.) |

Диаграммы форм волн (громкость во времени):

```text
$00-$03, $09:  |\        $04-$07, $0F:    /|
               | \                        / |
               |  \___                   /  |___

$08: |\  |\  |\            $0C:   /|  /|  /|
     | \ | \ | \                 / | / | / |
     |  \| \| \|                /  |/  |/  |

$0A: |\  /\  /\            $0E:   /\  /\  /\
     | \/  \/  \                 /  \/  \/  \/
     |          |               |

$0B: |\                    $0D:    /|
     | \                         / |
     |  ''''''''                /  |''''''''
```

<!-- figure: ch11_envelope_shapes -->
![AY envelope shape waveforms](illustrations/output/ch11_envelope_shapes.png)

**Ключевое понимание:** Запись в R13 *перезапускает* огибающую с начала. Это критически важно для басовых техник -- ты можешь запустить новый цикл огибающей в любой момент, записав в R13, даже с тем же значением.

---

## 11.2 Чиптюн-техники на 3 каналах

Три канала -- это немного. У настоящей группы как минимум бас, ударные, мелодия и гармония. Чиптюн-композиторы разработали изобретательные трюки для создания иллюзии большего:

### Арпеджио: имитация аккордов

Арпеджио быстро перебирает ноты аккорда -- по одной ноте на кадр. При 50 Гц (PAL) перебор C4, E4 и G4 каждый кадр создаёт эффект, который ухо воспринимает как аккорд до-мажор, хотя в каждый момент звучит только одна нота.

```z80 id:ch11_arpeggios_fake_chords
; Arpeggio: cycle C-E-G on channel A every frame
; Called once per frame from the interrupt handler
arpeggio:
    ld   a, (arp_pos)
    inc  a
    cp   3
    jr   nz, .no_wrap
    xor  a
.no_wrap:
    ld   (arp_pos), a

    ; Index into note table
    ld   hl, arp_notes
    add  a, a            ; x2 (each entry is a 16-bit period)
    ld   e, a
    ld   d, 0
    add  hl, de
    ld   e, (hl)
    inc  hl
    ld   d, (hl)

    ; Write period to channel A
    ld   a, R_TONE_A_LO
    call ay_write_de_lo
    ld   a, R_TONE_A_HI
    call ay_write_de_hi
    ret

arp_pos:   DB 0
arp_notes: DW 424, 337, 283    ; C4, E4, G4
```

В трекере арпеджио записывается как эффект, применяемый к нотам. Vortex Tracker II использует таблицы орнаментов, задающие покадровые смещения в полутонах.

### Buzz-bass: трюк с огибающей

Вот самый характерный чиптюн-басовый звук: "базз". Он работает через злоупотребление генератором огибающей. Устанавливаешь огибающую на короткую повторяющуюся пилу ($08 или $0C), устанавливаешь период огибающей, соответствующий желаемой частоте басовой ноты, и перезапускаешь огибающую каждый кадр. Результат -- жужжащий, плотный басовый тон, совершенно не похожий на простую прямоугольную волну.

```z80 id:ch11_buzz_bass_the_envelope_trick
; Buzz-bass: play bass note using envelope generator
; DE = envelope period for desired note
buzz_bass:
    ; Set envelope period
    ld   a, R_ENV_LO
    call ay_write_de_lo
    ld   a, R_ENV_HI
    call ay_write_de_hi

    ; Set envelope shape to repeating sawtooth down
    ; Writing R13 restarts the envelope
    ld   a, R_ENV_SHAPE
    ld   e, $08          ; \\\\  repeating sawtooth down
    call ay_write

    ; Set channel volume to envelope mode (bit 4 = 1)
    ld   a, R_VOL_C
    ld   e, $10          ; bit 4 set = use envelope
    call ay_write
    ret
```

Период огибающей для заданной басовой ноты:

```text
envelope_period = AY_clock / (256 x desired_frequency)
```

Для баса C2 (65,4 Гц): period = 1 773 400 / (256 x 65,4) = 106.

Buzz-bass даёт тебе басовый инструмент, звучащий принципиально иначе, чем тональные каналы, фактически добавляя четвёртый голос в аранжировку.

### Проблема выравнивания периодов

Есть подвох с buzz-bass, который равномерно-темперированные таблицы нот скрывают от тебя. Посмотри на формулу ещё раз:

```text
tone_period    = AY_clock / (16 x frequency)
envelope_period = tone_period / 16
```

Чтобы базз звучал чисто, период огибающей должен быть *точно* `tone_period / 16`. Но целочисленное деление обрезает. Если период тона не делится на 16, период огибающей имеет ошибку округления -- и форма волны огибающей дрейфует относительно тона, создавая слышимые биения.

Проверим нашу стандартную таблицу. Октава 4:

| Нота | Период | Период mod 16 | Огибающая = Период / 16 | Ошибка? |
|------|--------|---------------|-------------------------|---------|
| C4   | 424    | 8             | 26 (должно быть 26.5)    | Да     |
| D4   | 378    | 10            | 23 (должно быть 23.625)  | Да     |
| E4   | 337    | 1             | 21 (должно быть 21.0625) | Да     |
| F4   | 318    | 14            | 19 (должно быть 19.875)  | Да     |
| G4   | 283    | 11            | 17 (должно быть 17.6875) | Да     |
| A4   | 252    | 12            | 15 (должно быть 15.75)   | Да     |
| B4   | 225    | 1             | 14 (должно быть 14.0625) | Да     |

Ни одного чистого деления! Каждая нота в равномерно-темперированной шкале даёт слегка расстроенную огибающую. Для коротких перкуссионных басс-звуков биения маскируются, но для протяжных басовых нот они создают неприятное дрожание.

<!-- figure: ch11_te_alignment -->
![Tone + Envelope Phase Alignment: clean T+E with period divisible by 16 (top) vs beating T+E with rounding error (bottom)](illustrations/output/ch11_te_alignment.png)

### Натуральный строй: Таблица #5

В июне 2001 года Ivan Roshin опубликовал "Частотная таблица с нулевой погрешностью", придя к тому же выводу, который столетия музыкальной теории уже установили: заменить равномерную темперацию на *натуральный строй* -- целочисленные интервалы, которые аппаратура AY может делить чисто.

Натуральная шкала для до-мажор / ля-минор использует следующие интервалы:

```text
C [9/8] D [10/9] E [16/15] F [9/8] G [10/9] A [9/8] B [16/15] C
```

Это даёт чистые квинты (соотношение 3:2) для C--G, E--B, A--E. Хроматические ноты (диезы/бемоли) рассчитываются с соотношением 16/15.

<!-- figure: ch11_just_intonation -->
![Just Intonation: interval structure of the natural scale with period divisibility table for buzz-bass](illustrations/output/ch11_just_intonation.png)

Полученные периоды, рассчитанные для *нестандартной* тактовой частоты AY 1 520 640 Гц:

```z80 id:ch11_natural_tuning_table_5_2
; Table #5: Natural tuning for AY clock = 1,520,640 Hz
; 96 notes (8 octaves), C major / A minor
; Ivan Roshin (concept, 2001), oisee/siril (VTi implementation, 2009)
natural_note_table:
    ; Octave 1: every period divisible by 16!
    DW 2880, 2700, 2560, 2400, 2304, 2160
    DW 2025, 1920, 1800, 1728, 1620, 1536
    ; Octave 2
    DW 1440, 1350, 1280, 1200, 1152, 1080
    DW 1013,  960,  900,  864,  810,  768
    ; Octave 3
    DW  720,  675,  640,  600,  576,  540
    DW  506,  480,  450,  432,  405,  384
    ; Octave 4
    DW  360,  338,  320,  300,  288,  270
    DW  253,  240,  225,  216,  203,  192
    ; Octave 5
    DW  180,  169,  160,  150,  144,  135
    DW  127,  120,  113,  108,  101,   96
    ; Octave 6
    DW   90,   84,   80,   75,   72,   68
    DW   63,   60,   56,   54,   51,   48
    ; Octave 7
    DW   45,   42,   40,   38,   36,   34
    DW   32,   30,   28,   27,   25,   24
    ; Octave 8
    DW   23,   21,   20,   19,   18,   17
    DW   16,   15,   14,   14,   13,   12
```

Ключевое понимание в том, что большинство периодов основной шкалы теперь делятся на 16. Вот октава 2 -- басовый диапазон, наиболее важный для базза:

| Нота | Период | mod 16 | Огибающая = Период/16 | Чисто? |
|------|--------|--------|----------------------|--------|
| C2   | 1440   | 0      | 90                   | Да |
| C#2  | 1350   | 6      | 84.375 → 84          | Нет |
| D2   | 1280   | 0      | 80                   | Да |
| D#2  | 1200   | 0      | 75                   | Да |
| E2   | 1152   | 0      | 72                   | Да |
| F2   | 1080   | 8      | 67.5 → 68            | ~   |
| F#2  | 1013   | 5      | 63.3 → 63            | Нет |
| G2   |  960   | 0      | 60                   | Да |
| G#2  |  900   | 4      | 56.25 → 56           | Нет |
| A2   |  864   | 0      | 54                   | Да |
| A#2  |  810   | 10     | 50.6 → 51            | Нет |
| B2   |  768   | 0      | 48                   | Да |

| Нота | Период | mod 16 | Огибающая = Период/16 | Чисто? |
|------|--------|--------|----------------------|--------|
| C2   | 1440   | 0      | 90                   | Да |
| C#2  | 1350   | 6      | 84.375 → 84          | Нет |
| D2   | 1280   | 0      | 80                   | Да |
| D#2  | 1200   | 0      | 75                   | Да |
| E2   | 1152   | 0      | 72                   | Да |
| F2   | 1080   | 8      | 67.5 → 68            | ~ |
| F#2  | 1013   | 5      | 63.3 → 63            | Нет |
| G2   |  960   | 0      | 60                   | Да |
| G#2  |  900   | 4      | 56.25 → 56           | Нет |
| A2   |  864   | 0      | 54                   | Да |
| A#2  |  810   | 10     | 50.6 → 51            | Нет |
| B2   |  768   | 0      | 48                   | Да |

Семь из двенадцати нот делятся чисто -- все натуральные ноты до-мажора. Сравни с равномерно-темперированной таблицей, где *ни одна* не делится. На этих семи нотах генераторы огибающей и тона синхронизируются по фазе, и buzz-bass звучит чисто.

**Компромисс:** эта таблица верна только для до-мажор / ля-минор. Чтобы играть в других тональностях, нужно менять тактовую частоту AY:

| Тональность | Частота чипа (Гц) |
|-------------|---------------------|
| C/Am    | 1,520,640 |
| C#/A#m  | 1,611,062 |
| D/Bm    | 1,706,861 |
| D#/Cm   | 1,808,356 |
| E/C#m   | 1,915,886 |
| F/Dm    | 2,029,811 |
| F#/D#m  | 2,150,510 |
| G/Em    | 2,278,386 |
| G#/Fm   | 2,413,866 |
| A/F#m   | 2,557,401 |
| A#/Gm   | 2,709,472 |
| B/G#m   | 2,870,586 |

На реальном оборудовании тактовая частота AY фиксирована, поэтому ты не можешь менять тональности в рантайме. Но в эмуляторе или трекере вроде Vortex Tracker II "частота чипа" -- это настройка. Именно это сделала модификация Vortex Tracker Improved (VTi) от oisee в 2009 году: она добавила Таблицу #5 (пятую таблицу, индекс 4, считая с нуля) с этими натуральными периодами, плюс настройку частоты чипа для каждого модуля, выбирающую тональность.

Конвертер autosiril MIDI-to-PT3 по умолчанию использует Таблицу #5 именно из-за этих чистых соотношений огибающей -- большинство сконвертированных треков активно используют buzz-bass, и натуральный строй устраняет биения.

**На практике:** если ты пишешь трекерный модуль с интенсивным использованием buzz-bass, подумай о композиции в C/Am с Таблицей #5. Огибающие идеально синхронизируются с тоном. Если нужна другая тональность -- либо транспонируй частоту чипа (на стороне трекера), либо смирись с небольшими ошибками округления равномерной темперации. Для коротких перкуссионных базз-звуков разница неслышима; для протяжных басовых дронов она очень заметна.

### Синтез ударных

С единственным генератором шума ударные должны делить его. Стандартный подход:

```z80 id:ch11_drum_synthesis
; Snare: noise burst with fast decay
drum_snare:
    ; Noise period: mid-range
    ld   a, R_NOISE
    ld   e, 8
    call ay_write

    ; Mixer: enable noise on channel C
    ld   a, R_MIXER
    ld   e, $18          ; tones A+B+C on, noise C on
    call ay_write

    ; Short envelope: fast decay
    ld   a, R_ENV_LO
    ld   e, 200
    call ay_write
    ld   a, R_ENV_HI
    ld   e, 0
    call ay_write

    ; Envelope shape: single decay
    ld   a, R_ENV_SHAPE
    ld   e, $00          ; \___  single decay to silence
    call ay_write

    ; Channel C to envelope mode
    ld   a, R_VOL_C
    ld   e, $10
    call ay_write
    ret
```

```z80 id:ch11_drum_synthesis
; Snare: noise burst with fast decay
drum_snare:
    ; Noise period: mid-range
    ld   a, R_NOISE
    ld   e, 8
    call ay_write

    ; Mixer: enable noise on channel C
    ld   a, R_MIXER
    ld   e, $18          ; tones A+B+C on, noise C on
    call ay_write

    ; Short envelope: fast decay
    ld   a, R_ENV_LO
    ld   e, 200
    call ay_write
    ld   a, R_ENV_HI
    ld   e, 0
    call ay_write

    ; Envelope shape: single decay
    ld   a, R_ENV_SHAPE
    ld   e, $00          ; \___  single decay to silence
    call ay_write

    ; Channel C to envelope mode
    ld   a, R_VOL_C
    ld   e, $10
    call ay_write
    ret
```

```z80 id:ch11_drum_synthesis_2
; Kick: tone sweep down over 4 frames
; Call once per frame while kick_counter > 0
kick_update:
    ld   a, (kick_counter)
    or   a
    ret  z

    dec  a
    ld   (kick_counter), a

    ; Sweep tone down (increase period)
    ld   hl, (kick_period)
    ld   de, 40          ; sweep speed
    add  hl, de
    ld   (kick_period), hl

    ; Write to channel C
    ld   a, R_TONE_C_LO
    ld   e, l
    call ay_write
    ld   a, R_TONE_C_HI
    ld   e, h
    call ay_write
    ret

kick_counter: DB 0
kick_period:  DW 0
```

```z80 id:ch11_drum_synthesis_2
; Kick: tone sweep down over 4 frames
; Call once per frame while kick_counter > 0
kick_update:
    ld   a, (kick_counter)
    or   a
    ret  z

    dec  a
    ld   (kick_counter), a

    ; Sweep tone down (increase period)
    ld   hl, (kick_period)
    ld   de, 40          ; sweep speed
    add  hl, de
    ld   (kick_period), hl

    ; Write to channel C
    ld   a, R_TONE_C_LO
    ld   e, l
    call ay_write
    ld   a, R_TONE_C_HI
    ld   e, h
    call ay_write
    ret

kick_counter: DB 0
kick_period:  DW 0
```

**Хай-хэт:** очень короткий шумовой всплеск, высокая частота шума (низкое значение R6), немедленное снижение громкости после 1-2 кадров.

### Орнаменты: покадровая модуляция

```z80 id:ch11_ornaments_per_frame
; Example ornament: pitch vibrato
; Table of signed semitone offsets, applied once per frame
ornament_vibrato:
    DB 0, 0, 1, 1, 0, 0, -1, -1    ; 8-frame cycle
    DB $80                           ; end marker
```

```z80 id:ch11_ornaments_per_frame
; Example ornament: pitch vibrato
; Table of signed semitone offsets, applied once per frame
ornament_vibrato:
    DB 0, 0, 1, 1, 0, 0, -1, -1    ; 8-frame cycle
    DB $80                           ; end marker
```

---

---

## 11.3 TurboSound: 2 x AY

Pentagon и Scorpion-клоны представили TurboSound -- два чипа AY в одной машине. Второй чип адресуется через битовый паттерн, записываемый в порт $FFFD перед операциями с регистрами.

### Выбор чипа

```z80 id:ch11_chip_selection
; Select chip 0 (primary)
ld   bc, $FFFD
ld   a, $FF          ; bit pattern: select chip 0
out  (c), a

; Select chip 1 (secondary)
ld   bc, $FFFD
ld   a, $FE          ; bit pattern: select chip 1
out  (c), a
```

```z80 id:ch11_chip_selection
; Select chip 0 (primary)
ld   bc, $FFFD
ld   a, $FF          ; bit pattern: select chip 0
out  (c), a

; Select chip 1 (secondary)
ld   bc, $FFFD
ld   a, $FE          ; bit pattern: select chip 1
out  (c), a
```

После выбора чипа все последующие чтения и записи регистров через $FFFD/$BFFD идут к этому чипу. На практике твой музыкальный движок выбирает чип 0, обновляет все его регистры, затем выбирает чип 1 и обновляет его регистры.

### 6 каналов, настоящее стерео

TurboSound удваивает всё: 6 тональных каналов, 2 независимых генератора шума, 2 независимых генератора огибающей. Типичная стерео-расстановка:

| Чип | Каналы | Стерео | Роль |
|-----|--------|--------|------|
| Чип 0 | A0, B0, C0 | Лево или центр | Ведущая мелодия, гармония, бас |
| Чип 1 | A1, B1, C1 | Право или центр | Контрмелодия, пэды, ударные |

Или смешай их для широкого стерео-поля:
- Бас на обоих чипах (центр)
- Мелодия на чипе 0 (лево)
- Контрмелодия на чипе 1 (право)
- Ударные распределены: бочка на чипе 0, малый/хай-хэт на чипе 1

Что TurboSound меняет в музыкальном плане -- значительно: на одном AY композитор постоянно идёт на жертвы. Невозможно одновременно иметь протяжную басовую ноту, ведущую мелодию и удар барабана без кражи каналов. С TurboSound у тебя есть пространство. Выделенный басовый канал, выделенные ударные и четыре оставшихся голоса для мелодии и гармонии. Эра компромиссов заканчивается.

### Модификация движка

```z80 id:ch11_engine_modification
music_frame:
    ; Update chip 0
    ld   a, $FF
    ld   bc, $FFFD
    out  (c), a          ; select chip 0
    call update_chip0    ; write 14 registers

    ; Update chip 1
    ld   a, $FE
    ld   bc, $FFFD
    out  (c), a          ; select chip 1
    call update_chip1    ; write 14 registers
    ret
```

Цикл записи регистров записывает все 14 регистров из буфера в ОЗУ. Для двух чипов ты поддерживаешь два 14-байтных буфера и выгружаешь их последовательно. Каждая запись регистра требует выбора регистра (LD A,reg + OUT), затем записи значения (LD A,val + OUT), что стоит около 36 тактов (T-state) на регистр. На 28 регистров суммарно: примерно 1 008 тактов, плюс накладные расходы на выбор чипа.

---

Цикл записи регистров записывает все 14 регистров из буфера в ОЗУ. Для двух чипов ты поддерживаешь два 14-байтных буфера и выгружаешь их последовательно. Каждая запись регистра требует выбора регистра (LD A,reg + OUT), затем записи значения (LD A,val + OUT), что стоит около 36 тактов (T-state) на регистр. На 28 регистров суммарно: примерно 1 008 тактов, плюс накладные расходы на выбор чипа.

---

## 11.4 Triple AY на ZX Spectrum Next

ZX Spectrum Next идёт дальше: три AY-совместимых звуковых чипа, дающие 9 каналов. Но реализация Next выходит за рамки простого утроения.

### Расширенные возможности

Чипы AY на Next включают **панорамирование каждого канала**. Каждый канал может быть индивидуально распределён влево, вправо или по центру -- то, чего оригинальный AY никогда не поддерживал. Это управляется через дополнительные регистры, специфичные для Next.

Три чипа адресуются через регистр Next $06 (peripheral 2 setting) или через стандартный порт $FFFD со значениями выбора чипа.

### 9 каналов: оркестровое мышление

Девять каналов принципиально меняют подход к композиции на 8-битном оборудовании. Вместо хитрых трюков для имитации сложности ты можешь мыслить оркестрово:

---

Этого достаточно для по-настоящему богатых аранжировок. У тебя есть выделенный канал SFX, который никогда не прерывает музыку. У тебя есть независимые генераторы шума для многослойной перкуссии. Ты можешь держать аккорды без арпеджио. Характер AY сохраняется -- прямоугольные волны остаются прямоугольными -- но композиционная свобода приближается к свободе Amiga MOD-трекера с его четырьмя сэмплерными каналами.

---

## 11.5 Архитектура музыкального движка

Музыкальный движок -- это код, который читает данные паттернов и записывает регистры AY в правильном темпе. На Spectrum он живёт внутри обработчика прерываний.

```z80 id:ch11_the_interrupt_driven_player
; Setup: install IM2 handler
setup_im2:
    di
    ld   a, $C0          ; interrupt vector table at $C000
    ld   i, a
    im   2

    ; Fill vector table at $C000 with $C1C1
    ; Handler at $C1C1
    ld   hl, $C000
    ld   de, $C001
    ld   bc, 256
    ld   (hl), $C1
    ldir

    ; Place JP at $C1C1
    ld   a, $C3          ; JP opcode
    ld   ($C1C1), a
    ld   hl, isr_handler
    ld   ($C1C2), hl

    ei
    ret

isr_handler:
    push af
    push bc
    push de
    push hl
    ; ... push all registers you use ...

    call music_play      ; <-- the player routine

    ; ... pop all registers ...
    pop  hl
    pop  de
    pop  bc
    pop  af
    ei
    reti
```

IM2 (Interrupt Mode 2) ZX Spectrum срабатывает раз в кадр -- каждую 1/50 секунды на PAL-системах. Музыкальный движок подключается к нему:

```z80 id:ch11_the_interrupt_driven_player
; Setup: install IM2 handler
setup_im2:
    di
    ld   a, $C0          ; interrupt vector table at $C000
    ld   i, a
    im   2

    ; Fill vector table at $C000 with $C1C1
    ; Handler at $C1C1
    ld   hl, $C000
    ld   de, $C001
    ld   bc, 256
    ld   (hl), $C1
    ldir

    ; Place JP at $C1C1
    ld   a, $C3          ; JP opcode
    ld   ($C1C1), a
    ld   hl, isr_handler
    ld   ($C1C2), hl

    ei
    ret

isr_handler:
    push af
    push bc
    push de
    push hl
    ; ... push all registers you use ...

    call music_play      ; <-- the player routine

    ; ... pop all registers ...
    pop  hl
    pop  de
    pop  bc
    pop  af
    ei
    reti
```

### Цикл проигрывателя

Подпрограмма проигрывателя, вызываемая 50 раз в секунду, выполняет следующее:

```z80 id:ch11_the_player_loop
music_play:
    ; Decrement speed counter
    ld   a, (speed_counter)
    dec  a
    ld   (speed_counter), a
    ret  nz              ; not time for a new row yet

    ; Reset speed counter
    ld   a, (song_speed)
    ld   (speed_counter), a

    ; Process each channel
    ld   ix, channel_a_data
    call process_channel
    ld   ix, channel_b_data
    call process_channel
    ld   ix, channel_c_data
    call process_channel

    ; Write all registers to AY
    call ay_flush_registers
    ret
```

Упрощённый каркас:

```z80 id:ch11_the_player_loop
music_play:
    ; Decrement speed counter
    ld   a, (speed_counter)
    dec  a
    ld   (speed_counter), a
    ret  nz              ; not time for a new row yet

    ; Reset speed counter
    ld   a, (song_speed)
    ld   (speed_counter), a

    ; Process each channel
    ld   ix, channel_a_data
    call process_channel
    ld   ix, channel_b_data
    call process_channel
    ld   ix, channel_c_data
    call process_channel

    ; Write all registers to AY
    call ay_flush_registers
    ret
```

### Бюджет кадра

Вот критический вопрос: сколько тактов (T-state) может потреблять музыкальный движок, прежде чем он оставит основную программу голодной?

Кадр составляет 71 680 тактов (T-state) на Pentagon (69 888 на 48K). Прерывание срабатывает в начале кадра. Если музыкальный проигрыватель занимает 5 000 тактов, основной программе остаётся 66 680 на визуальные эффекты.

Типичные затраты:
- **Простой проигрыватель** (без эффектов, без орнаментов): ~1 500--2 500 тактов (T-state)
- **Проигрыватель Pro Tracker 3**: ~3 000--5 000 тактов (T-state)
- **Полный проигрыватель Vortex Tracker II** с орнаментами и эффектами: ~4 000--7 000 тактов (T-state)
- **Проигрыватель TurboSound** (2 чипа): ~6 000--10 000 тактов (T-state)

Для демо с ресурсоёмким эффектом 7 000 тактов на музыку -- это существенно -- около 10% кадра. Планируй соответственно.

### Форматы и трекеры

Современный стандарт для AY-музыки на Spectrum -- **Vortex Tracker II** (формат .pt3). Это кроссплатформенный трекер, работающий под Windows и выдающий файлы, непосредственно воспроизводимые проверенными Z80-проигрывателями.

| Формат | Трекер | Возможности | Размер проигрывателя |
|--------|--------|-------------|----------------------|
| .pt3 | Vortex Tracker II / Pro Tracker 3 | Орнаменты, сэмплы, эффекты | ~1.2-1.8 КБ |
| .asc | ASC Sound Master | Проще, меньший проигрыватель | ~0.8-1.0 КБ |
| .sqt | SQ-Tracker | Компактный, хорошее сжатие | ~0.6-0.8 КБ |
| .stc | Sound Tracker | Базовый, самый старый | ~0.5-0.7 КБ |

```z80 id:ch11_formats_and_trackers
; In your main code:
    ld   hl, song_data
    call music_init

; In your interrupt handler:
    call music_play

; At the end of the binary:
song_data:
    INCBIN "mysong.pt3"
```

1. Сочиняешь в Vortex Tracker II на PC
2. Экспортируешь как .pt3 файл
3. Включаешь исходник .pt3 проигрывателя (Z80 ассемблер) в свой проект
4. Включаешь файл данных .pt3 как бинарный блоб
5. Вызываешь `music_init` при запуске (передавая адрес данных песни)
6. Вызываешь `music_play` из обработчика прерываний каждый кадр

---

Это стандартный подход, используемый практически каждым демо и игрой для Spectrum 128K с начала 2000-х.

---

## 11.6 Система звуковых эффектов

```z80 id:ch11_channel_stealing
; Trigger a sound effect on the SFX channel
; HL = pointer to SFX data table
sfx_trigger:
    ld   (sfx_pointer), hl
    ld   a, 1
    ld   (sfx_active), a
    ld   a, 0
    ld   (sfx_frame), a
    ret

; Called every frame from the interrupt handler, AFTER music_play
sfx_update:
    ld   a, (sfx_active)
    or   a
    ret  z               ; no active SFX

    ; Read current SFX frame data
    ld   hl, (sfx_pointer)
    ld   a, (sfx_frame)
    ld   e, a
    ld   d, 0

    ; Each SFX frame: [tone_lo, tone_hi, noise, volume, mixer_mask]
    ; 5 bytes per frame
    push hl
    ld   b, 5
    call multiply_de_b   ; DE = frame * 5 (or use repeated add)
    pop  hl
    add  hl, de

    ld   a, (hl)
    cp   $FF             ; end marker?
    jr   z, .sfx_done

    ; Override channel C with SFX data
    ld   e, (hl) : inc hl
    ld   a, R_TONE_C_LO
    call ay_write

    ld   e, (hl) : inc hl
    ld   a, R_TONE_C_HI
    call ay_write

    ld   e, (hl) : inc hl
    ld   a, R_NOISE
    call ay_write

    ld   e, (hl) : inc hl
    ld   a, R_VOL_C
    call ay_write

    ; Advance frame counter
    ld   a, (sfx_frame)
    inc  a
    ld   (sfx_frame), a
    ret

.sfx_done:
    xor  a
    ld   (sfx_active), a ; deactivate SFX
    ret
```

### Кража каналов

```z80 id:ch11_channel_stealing
; Trigger a sound effect on the SFX channel
; HL = pointer to SFX data table
sfx_trigger:
    ld   (sfx_pointer), hl
    ld   a, 1
    ld   (sfx_active), a
    ld   a, 0
    ld   (sfx_frame), a
    ret

; Called every frame from the interrupt handler, AFTER music_play
sfx_update:
    ld   a, (sfx_active)
    or   a
    ret  z               ; no active SFX

    ; Read current SFX frame data
    ld   hl, (sfx_pointer)
    ld   a, (sfx_frame)
    ld   e, a
    ld   d, 0

    ; Each SFX frame: [tone_lo, tone_hi, noise, volume, mixer_mask]
    ; 5 bytes per frame
    push hl
    ld   b, 5
    call multiply_de_b   ; DE = frame * 5 (or use repeated add)
    pop  hl
    add  hl, de

    ld   a, (hl)
    cp   $FF             ; end marker?
    jr   z, .sfx_done

    ; Override channel C with SFX data
    ld   e, (hl) : inc hl
    ld   a, R_TONE_C_LO
    call ay_write

    ld   e, (hl) : inc hl
    ld   a, R_TONE_C_HI
    call ay_write

    ld   e, (hl) : inc hl
    ld   a, R_NOISE
    call ay_write

    ld   e, (hl) : inc hl
    ld   a, R_VOL_C
    call ay_write

    ; Advance frame counter
    ld   a, (sfx_frame)
    inc  a
    ld   (sfx_frame), a
    ret

.sfx_done:
    xor  a
    ld   (sfx_active), a ; deactivate SFX
    ret
```

### Процедурные таблицы SFX

```z80 id:ch11_procedural_sfx_tables
sfx_explosion:
    ; tone_lo, tone_hi, noise_period, volume, (unused)
    DB 0, 0, 15, 15, 0    ; frame 0: loud low noise
    DB 0, 0, 18, 13, 0    ; frame 1
    DB 0, 0, 20, 11, 0    ; frame 2
    DB 0, 0, 22, 9,  0    ; frame 3
    DB 0, 0, 25, 7,  0    ; frame 4
    DB 0, 0, 28, 5,  0    ; frame 5
    DB 0, 0, 30, 3,  0    ; frame 6
    DB 0, 0, 31, 1,  0    ; frame 7
    DB $FF                 ; end
```

**Взрыв:** шум с затухающей громкостью.

```z80 id:ch11_procedural_sfx_tables_2
sfx_laser:
    DB 10, 0, 0, 14, 0    ; frame 0: high tone
    DB 30, 0, 0, 13, 0    ; frame 1: sweeping down
    DB 60, 0, 0, 12, 0    ; frame 2
    DB 100,0, 0, 10, 0    ; frame 3
    DB 160,0, 0, 8,  0    ; frame 4
    DB 240,0, 0, 5,  0    ; frame 5
    DB 200,1, 0, 3,  0    ; frame 6: into low range
    DB $FF                 ; end
```

**Лазер:** быстрый свип тона вниз.

```z80 id:ch11_procedural_sfx_tables_3
sfx_jump:
    DB 200,0, 0, 12, 0    ; frame 0: mid tone
    DB 150,0, 0, 11, 0    ; frame 1: rising
    DB 100,0, 0, 10, 0    ; frame 2
    DB 60, 0, 0, 8,  0    ; frame 3: high
    DB 40, 0, 0, 5,  0    ; frame 4
    DB $FF                 ; end
```

**Прыжок:** короткий свип тона вверх.

```z80 id:ch11_procedural_sfx_tables_4
sfx_pickup:
    DB $FC,0, 0, 14, 0    ; frame 0: A4
    DB $D4,0, 0, 13, 0    ; frame 1: C5
    DB $A0,0, 0, 12, 0    ; frame 2: E5 (approx)
    DB $6A,0, 0, 11, 0    ; frame 3: C6 (approx)
    DB $6A,0, 0, 8,  0    ; frame 4: sustain
    DB $6A,0, 0, 4,  0    ; frame 5: fade
    DB $FF                 ; end
```

---

```z80 id:ch11_procedural_sfx_tables_4
sfx_pickup:
    DB $FC,0, 0, 14, 0    ; frame 0: A4
    DB $D4,0, 0, 13, 0    ; frame 1: C5
    DB $A0,0, 0, 12, 0    ; frame 2: E5 (approx)
    DB $6A,0, 0, 11, 0    ; frame 3: C6 (approx)
    DB $6A,0, 0, 8,  0    ; frame 4: sustain
    DB $6A,0, 0, 4,  0    ; frame 5: fade
    DB $FF                 ; end
```

---

## 11.7 Собираем всё вместе: рабочий пример

Файл `chapters/ch11-sound/examples/ay_test.a80` содержит полный, компилирующийся пример, демонстрирующий основы: инициализацию AY, настройку микшера, запись периодов тона и воспроизведение мелодии. Изучай его параллельно с этой главой -- каждая рассмотренная здесь концепция применяется в этом коде.

Ключевые паттерны, на которые стоит обратить внимание в примере:

---

Чтобы расширить этот пример до настоящего музыкального проигрывателя, нужно заменить линейную таблицу мелодии на данные на основе паттернов, добавить обработку орнаментов и перенести воспроизведение в обработчик прерываний IM2, чтобы основной цикл был свободен для визуальных эффектов.

---

> ## Врезка: Beeper -- краткая история невозможного
>
> До 128K и его чипа AY оригинальный 48K Spectrum имел ровно один бит аудиовыхода. Пин 4 порта $FE. Высокий или низкий. Вот и всё.
>
> Один бит означает одну прямоугольную волну с частотой, с которой ты его переключаешь. Никакого контроля громкости, никакого микширования, никакой аппаратной помощи. Чтобы воспроизвести ноту, ты сидишь в тесном цикле, переключая бит на нужной частоте. Чтобы воспроизвести *две* ноты, ты чередуешь два цикла переключения. Чтобы три -- чередуешь три. Каждый дополнительный голос поглощает процессорное время, которое могло бы тратиться на что-то другое -- скажем, на рисование графики.
>
> И тем не менее.
>
> Между 2010 и 2015 годами Shiru (Shiru Otaku) каталогизировал примерно 30 различных движков бипера, каждый из которых использовал свою технику для извлечения многоголосия из одного бита. Подходы варьировались от простого чередования пульсов с pin-совместимостью (2-3 канала) до выдающихся инженерных подвигов:
>
> - **ZX-16** от Jan Deak: 16-канальное многоголосие на одном бите. Шестнадцать. Процессор не делает ничего, кроме переключения бита динамика по тщательно рассчитанному расписанию, аппроксимирующему сумму 16 независимых волновых форм через импульсно-плотностную модуляцию.
>
> - **Octode XL**: 8-канальный движок бипера, который действительно оставляет достаточно ЦП для визуальных эффектов.
>
> - **Rain** от Life on Mars (2016): полноценное демо, работающее с 9-канальным движком бипера *одновременно с визуальными эффектами* на 48K Spectrum. Вся постановка -- музыка и графика -- работает без чипа AY, без переключения банков, без чего-либо сверх базовой машины.
>
> Это одни из самых выдающихся инженерных достижений в 8-битных вычислениях. Они доказывают, что ограничения проницаемее, чем кажутся. Но они также непрактичны для общего применения: большинство движков бипера потребляют 50-90% процессорного времени, почти ничего не оставляя для геймплея или эффектов. Чип AY существует именно для того, чтобы разгрузить генерацию звука на выделенное оборудование.
>
> Мы рассматриваем здесь движки бипера как исторический контекст и вдохновение. Для практической музыки в демо и играх AY -- то, на чём стоит сосредоточить усилия.

---

> ## Врезка: Agon Light 2 -- звуковая система VDP
>
> Agon Light 2 использует совершенно другой подход к звуку. Его аудио генерируется сопроцессором ESP32 (VDP), а не выделенным звуковым чипом. Ты отправляешь VDU-команды по последовательной связи, и ESP32 синтезирует аудио программно.
>
> **Формы волн:** звуковая система Agon предлагает несколько типов форм волн на каждый канал -- прямоугольная, синусоидальная, треугольная, пилообразная и шум. Это уже гибче, чем генераторы тона AY, ограниченные прямоугольной волной.
>
> **ADSR-огибающие:** каждый канал имеет полностью программируемую огибающую Attack-Decay-Sustain-Release. Без совместного использования -- каждый канал получает свою независимую огибающую, в отличие от единственного общего генератора огибающей AY.
>
> **Количество каналов:** звуковая система VDP поддерживает несколько одновременных каналов (точное число зависит от версии прошивки, но обычно 8 и более).
>
> **Компромисс:** звук Agon управляется через VDU-байтовые последовательности, отправляемые по последовательной связи. Это означает:
> - Более высокую задержку, чем прямая запись в регистры (время последовательной передачи)
> - Менее точный тайминг (невозможно bit-bang-ить синхронизацию с точностью до такта)
> - Но значительно меньшую нагрузку на ЦП (eZ80 просто отправляет команды; ESP32 делает весь синтез)
>
> Парадигма ближе к MIDI, чем к программированию на уровне регистров. Ты говоришь VDP "воспроизведи эту ноту на канале 3 синусоидальной волной с такой ADSR-огибающей", и он делает остальное. Музыкальные цели те же -- мелодия, бас, ударные, эффекты -- но модель программирования принципиально другая. Нет регистра микшера, нет расчётов периодов, нет таблиц форм огибающей. Только команды и параметры.
>
> Для кроссплатформенных проектов подумай об абстракции звуковой системы за общим API: `sound_play_note(channel, note, instrument)`. На Spectrum поиск инструмента записывает регистры AY. На Agon -- отправляет VDU-команды. Одни и те же музыкальные данные, разные бэкенды.

---

## 11.8 Практические упражнения

**Упражнение 1: Обозреватель регистров.** Напиши программу, позволяющую изменять любой регистр AY в реальном времени с помощью клавиатурного ввода. Отображай все 14 значений регистров на экране. Это твой единственный самый полезный инструмент отладки для работы со звуком.

**Упражнение 2: Трёхканальная аранжировка.** Сочини простую 16-тактовую мелодию, используя все три канала: мелодия на A, бас (buzz-bass с огибающей) на C, арпеджированные аккорды на B. Используй тайминг на HALT из примера как отправную точку, затем перепиши его в проигрыватель на IM2.

---

**Упражнение 4: Интеграция Vortex Tracker.** Скачай Vortex Tracker II, сочини короткую мелодию, экспортируй как .pt3, и интегрируй стандартный .pt3 проигрыватель в программу для Spectrum. Убедись, что она воспроизводится корректно в эмуляторе.

AY-3-8910 на бумаге прост: 14 регистров, 3 канала, базовые формы волн. Но пропасть между «простым» и «ограниченным» заполняется техникой. Арпеджио имитируют аккорды. Злоупотребление огибающей создаёт бас. Формирование шума синтезирует ударные. Орнаменты вдыхают жизнь в статичные тоны. А когда трёх каналов действительно мало, TurboSound удваивает их, а Next утраивает.

## Итого

---

Архитектурный паттерн одинаков для всех конфигураций: прерывание срабатывает 50 раз в секунду, подпрограмма проигрывателя считывает данные паттернов и вычисляет значения регистров, и эти значения выгружаются в AY в тесном цикле. Пишешь ли ты свой собственный проигрыватель или интегрируешь Vortex Tracker -- поток тот же. Понимание регистров означает понимание звука.
