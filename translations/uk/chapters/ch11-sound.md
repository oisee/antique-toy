# Розділ 11: Звукова архітектура -- AY, TurboSound і Triple AY

> *"Чип AY має три голоси. Це не обмеження -- це конструктивна умова, що сформувала цілий музичний жанр."*

---

AY-3-8910 -- це голос ZX Spectrum 128K. Компанія General Instrument розробила його у 1978 році як програмований звуковий генератор (PSG) -- єдиний чип, здатний відтворювати музику та звукові ефекти без виділеного звукового процесора. На момент, коли Amstrad встановила його у Spectrum 128K у 1986 році, він уже був перевіреним робочим конем: Intellivision, MSX, Atari ST та десятки аркадних автоматів використовували його або його сумісні за виводами варіанти (YM2149 в Atari ST, AY-3-8912 з меншою кількістю портів вводу-виводу).

Чотирнадцять регістрів. Три канали прямокутних хвиль. Один генератор шуму. Один генератор обвідної. Це все, що ти маєш. Все, що ти коли-небудь чув у чіптюні ZX Spectrum 128K -- пульсуючі басові лінії, швидкострільні арпеджовані акорди, уривчасті барабани -- виникає від програмування цих чотирнадцяти регістрів п'ятдесят разів на секунду.

Цей розділ проведе тебе від простих записів у регістри до робочого музичного рушія. Наприкінці ти точно розумітимеш, як трекерний програвач подає звук на AY, і матимеш знання для створення власного.

---

## 11.1 Карта регістрів AY-3-8910

AY має 14 регістрів, адресованих R0 -- R13. На ZX Spectrum 128K доступ до них здійснюється через два порти вводу-виводу:

- **$FFFD** -- Вибір регістра (спочатку запиши сюди номер регістра)
- **$BFFD** -- Запис даних (потім запиши сюди значення)

Завжди спочатку обирай регістр, потім записуй дані. Цей двокроковий процес є фундаментальним:

```z80
; Write value E to AY register A
ay_write:
    ld   bc, $FFFD
    out  (c), a       ; select register
    ld   b, $BF       ; $BFFD high byte (C stays $FD)
    out  (c), e       ; write data
    ret
```

Зверни увагу на трюк: ми змінюємо лише старший байт BC між двома інструкціями OUT. Молодший байт $FD залишається в C протягом усього часу. Це економить повторне завантаження повного 16-бітного значення.

### Повна таблиця регістрів

| Рег | Назва | Біти | Опис |
|-----|-------|------|------|
| R0  | Період тону A, молодший | 8 | Молодші 8 біт періоду тону каналу A |
| R1  | Період тону A, старший | 4 | Старші 4 біти періоду тону каналу A |
| R2  | Період тону B, молодший | 8 | Молодші 8 біт періоду тону каналу B |
| R3  | Період тону B, старший | 4 | Старші 4 біти періоду тону каналу B |
| R4  | Період тону C, молодший | 8 | Молодші 8 біт періоду тону каналу C |
| R5  | Період тону C, старший | 4 | Старші 4 біти періоду тону каналу C |
| R6  | Період шуму | 5 | Період генератора шуму (0-31) |
| R7  | Мікшер / увімкнення вводу-виводу | 8 | Увімкнення тону та шуму для кожного каналу + ввід-вивід |
| R8  | Гучність A | 5 | Гучність каналу A (0-15) або режим обвідної |
| R9  | Гучність B | 5 | Гучність каналу B (0-15) або режим обвідної |
| R10 | Гучність C | 5 | Гучність каналу C (0-15) або режим обвідної |
| R11 | Період обвідної, молодший | 8 | Молодші 8 біт періоду обвідної |
| R12 | Період обвідної, старший | 8 | Старші 8 біт періоду обвідної |
| R13 | Форма обвідної | 4 | Форма хвилі обвідної (0-15) |

![AY-3-8910 register map](illustrations/output/ch11_ay_registers.png)

### Тональні канали (R0-R5): Як працює висота тону

Кожний з трьох тональних каналів генерує прямокутну хвилю. Частота контролюється 12-бітним значенням періоду, розділеним між двома регістрами:

```
Frequency = AY_clock / (16 x period)
```

На Spectrum 128K тактова частота AY становить 1,7734 МГц (половина тактової частоти процесора 3,5469 МГц). Отже, для ноти "до" першої октави (приблизно 262 Гц):

```
period = 1,773,400 / (16 x 262) = 423
```

12-бітний період дає діапазон від 1 (110 837 Гц -- нечутний ультразвук) до 4095 (27 Гц -- глибокий басовий гул). Ось практична таблиця нот для четвертої октави:

| Нота | Частота (Гц) | Період (десятковий) | R_LO | R_HI |
|------|-------------|---------------------|------|------|
| C4   | 261.6 | 424 | $A8 | $01 |
| C#4  | 277.2 | 400 | $90 | $01 |
| D4   | 293.7 | 378 | $7A | $01 |
| D#4  | 311.1 | 357 | $65 | $01 |
| E4   | 329.6 | 337 | $51 | $01 |
| F4   | 349.2 | 318 | $3E | $01 |
| F#4  | 370.0 | 300 | $2C | $01 |
| G4   | 392.0 | 283 | $1B | $01 |
| G#4  | 415.3 | 267 | $0B | $01 |
| A4   | 440.0 | 252 | $FC | $00 |
| A#4  | 466.2 | 238 | $EE | $00 |
| B4   | 493.9 | 225 | $E1 | $00 |
| C5   | 523.3 | 212 | $D4 | $00 |

Щоб піднятися на одну октаву вгору, поділи період навпіл. Щоб опуститися -- подвой його. Повна таблиця нот для всіх корисних октав міститься в Додатку G.

### Генератор шуму (R6)

Регістр R6 керує єдиним генератором шуму, спільним для всіх трьох каналів. 5-бітне значення (0-31) задає "висоту" шуму -- менші значення дають вищий, шиплячий шум; більші значення дають нижчий, грубіший шум. Генератор шуму створює псевдовипадковий вихід за допомогою 17-бітного лінійного зсувного регістра зі зворотним зв'язком.

Корисні діапазони:
- **0-5**: Високий шип (хай-хет, тарілка)
- **6-12**: Середній шум (тіло малого барабана)
- **13-20**: Низький гул (вибух)
- **21-31**: Дуже низький (вітер, грім)

### R7: Мікшер -- Найважливіший регістр

Регістр R7 -- це серце AY. Шість біт контролюють, які канали отримують тон, шум або обидва. Ще два біти контролюють напрямок портів вводу-виводу (для звуку не мають значення, залиш їх як входи = 1).

```
Bit 7: I/O port B direction (1 = input)
Bit 6: I/O port A direction (1 = input)
Bit 5: Noise C enable (0 = ON, 1 = off)
Bit 4: Noise B enable (0 = ON, 1 = off)
Bit 3: Noise A enable (0 = ON, 1 = off)
Bit 2: Tone C enable  (0 = ON, 1 = off)
Bit 1: Tone B enable  (0 = ON, 1 = off)
Bit 0: Tone A enable  (0 = ON, 1 = off)
```

**Заплутана частина: 0 означає УВІМКНЕНО.** Це збиває з пантелику кожного з першого разу. AY використовує логіку з активним низьким рівнем для мікшерних дозволів. Скинутий біт вмикає відповідне джерело.

Ось таблиця корисних комбінацій мікшера:

| Значення | Двійкове (NcNbNa TcTbTa) | Ефект |
|----------|--------------------------|-------|
| $38   | `111 000` | Всі три тони ввімкнені, без шуму |
| $3E   | `111 110` | Лише тон A |
| $3D   | `111 101` | Лише тон B |
| $3B   | `111 011` | Лише тон C |
| $36   | `110 110` | Тон A + Шум A |
| $07   | `000 111` | Три шуми, без тонів |
| $30   | `110 000` | Тони A+B+C, Шум A |
| $00   | `000 000` | Все ввімкнено (какофонія) |
| $3F   | `111 111` | Все вимкнено (тиша) |

Типовий патерн для музики: тони A+B для мелодії та гармонії, тон C + шум C для ударних:

```
; Mixer: tone A on, tone B on, tone C on, noise C on
; Binary: 10 0 000 = noise C on + all tones on
; = $28
ld   a, R_MIXER
ld   e, $28
call ay_write
```

### Регістри гучності (R8-R10)

Кожний канал має 4-бітне керування гучністю (0-15, де 15 -- найгучніше). Але біт 4 особливий: його встановлення перемикає канал у **режим обвідної**, де гучність автоматично контролюється генератором обвідної замість фіксованого значення.

```
Bit 4: 1 = use envelope generator, 0 = use bits 3-0
Bits 3-0: Fixed volume level (0-15)
```

Крива гучності логарифмічна на справжньому AY-3-8910 (кожний крок -- приблизно 1,5 дБ), але відрізняється між ревізіями чипів та клонами. YM2149 має іншу криву гучності, тому одна й та сама мелодія звучить трохи по-різному на Atari ST порівняно зі Spectrum.

### Генератор обвідної (R11-R13)

AY має один генератор обвідної -- спільний для всіх каналів, що його використовують. Він автоматично модулює гучність відповідно до повторюваної форми хвилі.

**R11-R12: Період обвідної** -- 16-бітне значення, що контролює швидкість обвідної:

```
Envelope_frequency = AY_clock / (256 x period)
```

При періоді = 1 обвідна циклює з частотою приблизно 6 927 Гц. При періоді = 65535 вона циклює з частотою приблизно 0,11 Гц -- близько одного разу на 9 секунд.

**R13: Форма обвідної** -- Чотири біти обирають форму хвилі. Хоча 4 біти дозволяють 16 значень, лише 10 форм є унікальними:

| Значення | Форма | Опис |
|----------|-------|------|
| $00-$03 | `\___` | Одинарне згасання, потім тиша. (Всі чотири ідентичні.) |
| $04-$07 | `/___` | Одинарна атака, потім тиша. (Всі чотири ідентичні.) |
| $08 | `\\\\` | Повторюваний спадний пилкоподібний. |
| $09 | `\___` | Одинарне згасання, потім тиша. (Те саме, що $00.) |
| $0A | `\/\/` | Повторюваний трикутник (згасання-атака). |
| $0B | `\'''` | Одинарне згасання, потім утримання на максимумі. |
| $0C | `////` | Повторюваний висхідний пилкоподібний. |
| $0D | `/'''` | Одинарна атака, потім утримання на максимумі. |
| $0E | `/\/\` | Повторюваний трикутник (атака-згасання). |
| $0F | `/___` | Одинарна атака, потім тиша. (Те саме, що $04.) |

Діаграми форм хвиль (гучність у часі):

```
$00-$03, $09:  |\        $04-$07, $0F:    /|
               | \                        / |
               |  \___                   /  |___

$08: |\  |\  |\            $0C:   /|  /|  /|
     | \ | \ | \                 / | / | / |
     |  \| \| \|                /  |/  |/  |

$0A: |\  /\  /\            $0E:   /\  /\  /\
     | \/  \/  \                 /  \/  \/  \/
     |          |               |

$0B: |\                    $0D:    /|
     | \                         / |
     |  ''''''''                /  |''''''''
```

![AY envelope shape waveforms](illustrations/output/ch11_envelope_shapes.png)

**Ключовий момент:** Запис до R13 *перезапускає* обвідну з початку. Це критично для басових прийомів -- ти можеш запустити новий цикл обвідної в будь-який момент, записавши до R13, навіть з тим самим значенням.

---

## 11.2 Техніки чіптюну на 3 каналах

Три канали -- це небагато. Справжній гурт має бас, ударні, мелодію та гармонію як мінімум. Чіптюн-композитори розробили геніальні трюки для створення ілюзії більшої кількості:

### Арпеджіо: Фальшиві акорди

Арпеджіо швидко перебирає ноти акорду -- одна нота за кадр. На частоті 50 Гц (PAL) перебір C4, E4 та G4 кожний кадр створює ефект, який вухо сприймає як акорд до-мажор, навіть якщо в кожний момент звучить лише одна нота.

```z80
; Arpeggio: cycle C-E-G on channel A every frame
; Called once per frame from the interrupt handler
arpeggio:
    ld   a, (arp_pos)
    inc  a
    cp   3
    jr   nz, .no_wrap
    xor  a
.no_wrap:
    ld   (arp_pos), a

    ; Index into note table
    ld   hl, arp_notes
    add  a, a            ; x2 (each entry is a 16-bit period)
    ld   e, a
    ld   d, 0
    add  hl, de
    ld   e, (hl)
    inc  hl
    ld   d, (hl)

    ; Write period to channel A
    ld   a, R_TONE_A_LO
    call ay_write_de_lo
    ld   a, R_TONE_A_HI
    call ay_write_de_hi
    ret

arp_pos:   DB 0
arp_notes: DW 424, 337, 283    ; C4, E4, G4
```

У трекері арпеджіо записується як ефекти, застосовані до нот. Vortex Tracker II використовує таблиці орнаментів, що задають зміщення у півтонах на кожний тік.

### Buzz-Bass: Трюк з обвідною

Ось найхарактерніший басовий звук чіптюну: "базз". Він працює завдяки зловживанню генератором обвідної. Встанови обвідну на короткий повторюваний пилкоподібний сигнал ($08 або $0C), встанови період обвідної відповідно до бажаної частоти басової ноти та перезапускай обвідну кожний кадр. Результат -- гудіння, щільний басовий тон, що зовсім не схожий на просту прямокутну хвилю.

```z80
; Buzz-bass: play bass note using envelope generator
; DE = envelope period for desired note
buzz_bass:
    ; Set envelope period
    ld   a, R_ENV_LO
    call ay_write_de_lo
    ld   a, R_ENV_HI
    call ay_write_de_hi

    ; Set envelope shape to repeating sawtooth down
    ; Writing R13 restarts the envelope
    ld   a, R_ENV_SHAPE
    ld   e, $08          ; \\\\  repeating sawtooth down
    call ay_write

    ; Set channel volume to envelope mode (bit 4 = 1)
    ld   a, R_VOL_C
    ld   e, $10          ; bit 4 set = use envelope
    call ay_write
    ret
```

Період обвідної для заданої басової ноти:

```
envelope_period = AY_clock / (256 x desired_frequency)
```

Для басового C2 (65,4 Гц): період = 1 773 400 / (256 x 65,4) = 106.

Buzz-bass дає тобі басовий інструмент, який звучить принципово інакше від тональних каналів, фактично додаючи четвертий голос до твоєї аранжування.

### Проблема вирівнювання періодів

З buzz-bass є одна пастка, яку рівномірно темперовані таблиці нот від тебе приховують. Подивися на формулу ще раз:

```
tone_period    = AY_clock / (16 x frequency)
envelope_period = tone_period / 16
```

Щоб базз звучав чисто, період обвідної має бути *точно* `tone_period / 16`. Але цілочисельне ділення відкидає залишок. Якщо період тону не ділиться на 16, період обвідної має похибку округлення -- і форма обвідної дрейфує відносно тону, створюючи чутні биття.

Перевіримо нашу стандартну таблицю. Четверта октава:

| Нота | Період | Період mod 16 | Обвідна = Період / 16 | Похибка? |
|------|--------|---------------|------------------------|----------|
| C4   | 424    | 8             | 26 (повинно бути 26.5)    | Так    |
| D4   | 378    | 10            | 23 (повинно бути 23.625)  | Так    |
| E4   | 337    | 1             | 21 (повинно бути 21.0625) | Так    |
| F4   | 318    | 14            | 19 (повинно бути 19.875)  | Так    |
| G4   | 283    | 11            | 17 (повинно бути 17.6875) | Так    |
| A4   | 252    | 12            | 15 (повинно бути 15.75)   | Так    |
| B4   | 225    | 1             | 14 (повинно бути 14.0625) | Так    |

Жодного чистого ділення! Кожна нота рівномірно темперованого строю дає трохи розстроєну обвідну. Для коротких перкусійних buzz-звуків биття маскуються, але для тривалих басових нот вони створюють неприємне тремтіння.

![Tone + Envelope Phase Alignment: clean T+E with period divisible by 16 (top) vs beating T+E with rounding error (bottom)](illustrations/output/ch11_te_alignment.png)

### Натуральний стрій: Таблиця #5

У червні 2001 року Ivan Roshin опублікував "Частотная таблица с нулевой погрешностью" (Частотна таблиця з нульовою похибкою), дійшовши того самого висновку, що й століття теорії музики: замінити рівномірну темперацію на *натуральний стрій* -- цілочисельні співвідношення інтервалів, які апаратура AY може ділити чисто.

Натуральна гама для до-мажор / ля-мінор використовує такі інтервали:

```
C [9/8] D [10/9] E [16/15] F [9/8] G [10/9] A [9/8] B [16/15] C
```

Це дає чисті квінти (співвідношення 3:2) для C--G, E--B, A--E. Хроматичні ноти (дієзи/бемолі) обчислюються зі співвідношенням 16/15.

![Just Intonation: interval structure of the natural scale with period divisibility table for buzz-bass](illustrations/output/ch11_just_intonation.png)

Отримані періоди, обчислені для *нестандартної* тактової частоти AY 1 520 640 Гц:

```z80
; Table #5: Natural tuning for AY clock = 1,520,640 Hz
; 96 notes (8 octaves), C major / A minor
; Ivan Roshin (concept, 2001), oisee/siril (VTi implementation, 2009)
natural_note_table:
    ; Octave 1: every period divisible by 16!
    DW 2880, 2700, 2560, 2400, 2304, 2160
    DW 2025, 1920, 1800, 1728, 1620, 1536
    ; Octave 2
    DW 1440, 1350, 1280, 1200, 1152, 1080
    DW 1013,  960,  900,  864,  810,  768
    ; Octave 3
    DW  720,  675,  640,  600,  576,  540
    DW  506,  480,  450,  432,  405,  384
    ; Octave 4
    DW  360,  338,  320,  300,  288,  270
    DW  253,  240,  225,  216,  203,  192
    ; Octave 5
    DW  180,  169,  160,  150,  144,  135
    DW  127,  120,  113,  108,  101,   96
    ; Octave 6
    DW   90,   84,   80,   75,   72,   68
    DW   63,   60,   56,   54,   51,   48
    ; Octave 7
    DW   45,   42,   40,   38,   36,   34
    DW   32,   30,   28,   27,   25,   24
    ; Octave 8
    DW   23,   21,   20,   19,   18,   17
    DW   16,   15,   14,   14,   13,   12
```

Ключовий момент у тому, що більшість періодів основної гами тепер діляться на 16. Ось друга октава -- басовий діапазон, який найбільш важливий для buzz:

| Нота | Період | mod 16 | Обвідна = Період/16 | Чисто? |
|------|--------|--------|---------------------|--------|
| C2   | 1440   | 0      | 90                   | Так |
| C#2  | 1350   | 6      | 84.375 -> 84          | Ні  |
| D2   | 1280   | 0      | 80                   | Так |
| D#2  | 1200   | 0      | 75                   | Так |
| E2   | 1152   | 0      | 72                   | Так |
| F2   | 1080   | 0      | 67.5 -> 68            | ~   |
| F#2  | 1013   | 5      | 63.3 -> 63            | Ні  |
| G2   |  960   | 0      | 60                   | Так |
| G#2  |  900   | 4      | 56.25 -> 56           | Ні  |
| A2   |  864   | 0      | 54                   | Так |
| A#2  |  810   | 2      | 50.6 -> 51            | Ні  |
| B2   |  768   | 0      | 48                   | Так |

Сім з дванадцяти нот діляться чисто -- всі натуральні ноти до-мажору. Порівняй з рівномірно темперованою таблицею, де *жодна* не ділиться. На цих семи нотах генератори обвідної та тону синхронізуються по фазі, і buzz-bass звучить чисто.

**Компроміс:** ця таблиця коректна лише для до-мажор / ля-мінор. Для гри в інших тональностях ти змінюєш тактову частоту чипа AY:

| Тональність | Частота чипа (Гц) |
|-------------|-------------------|
| C/Am    | 1,520,640 |
| C#/A#m  | 1,611,062 |
| D/Bm    | 1,706,861 |
| D#/Cm   | 1,808,356 |
| E/C#m   | 1,915,886 |
| F/Dm    | 2,029,811 |
| F#/D#m  | 2,150,510 |
| G/Em    | 2,278,386 |
| G#/Fm   | 2,413,866 |
| A/F#m   | 2,557,401 |
| A#/Gm   | 2,709,472 |
| B/G#m   | 2,870,586 |

На реальному залізі тактова частота AY фіксована, тому ти не можеш реально змінювати тональності під час виконання. Але в емуляторі або трекері на кшталт Vortex Tracker II "частота чипа" -- це налаштування. Саме це зробила модифікація Vortex Tracker Improved (VTi) від oisee у 2009 році: вона додала Таблицю #5 (п'яту таблицю, індекс 4 при відліку від нуля) з цими натуральними періодами, плюс налаштування частоти чипа для кожного модуля, що обирає тональність.

Конвертер MIDI-в-PT3 autosiril за замовчуванням використовує Таблицю #5 саме через ці чисті співвідношення для обвідної -- більшість конвертованих треків широко використовують buzz-bass, і натуральний стрій усуває биття.

**На практиці:** якщо ти пишеш трекерний модуль, що сильно спирається на buzz-bass, подумай про композицію в C/Am з Таблицею #5. Обвідні ідеально синхронізуються з тоном. Якщо тобі потрібна інша тональність, або транспонуй частоту чипа (на стороні трекера), або погодься з невеликими похибками округлення рівномірної темперації. Для коротких перкусійних buzz-звуків різниця нечутна; для тривалих басових дронів вона дуже помітна.

### Синтез ударних

Маючи лише один генератор шуму, ударні повинні ділити його. Стандартний підхід:

**Малий барабан:** Канал шуму + швидке згасання обвідної.

```z80
; Snare: noise burst with fast decay
drum_snare:
    ; Noise period: mid-range
    ld   a, R_NOISE
    ld   e, 8
    call ay_write

    ; Mixer: enable noise on channel C
    ld   a, R_MIXER
    ld   e, $28          ; tones A+B on, tone C on, noise C on
    call ay_write

    ; Short envelope: fast decay
    ld   a, R_ENV_LO
    ld   e, 200
    call ay_write
    ld   a, R_ENV_HI
    ld   e, 0
    call ay_write

    ; Envelope shape: single decay
    ld   a, R_ENV_SHAPE
    ld   e, $00          ; \___  single decay to silence
    call ay_write

    ; Channel C to envelope mode
    ld   a, R_VOL_C
    ld   e, $10
    call ay_write
    ret
```

**Бочка (кік):** Швидкий спадний свіп тону. Встанови канал C на низький період тону, потім збільшуй період протягом кількох кадрів:

```z80
; Kick: tone sweep down over 4 frames
; Call once per frame while kick_counter > 0
kick_update:
    ld   a, (kick_counter)
    or   a
    ret  z

    dec  a
    ld   (kick_counter), a

    ; Sweep tone down (increase period)
    ld   hl, (kick_period)
    ld   de, 40          ; sweep speed
    add  hl, de
    ld   (kick_period), hl

    ; Write to channel C
    ld   a, R_TONE_C_LO
    ld   e, l
    call ay_write
    ld   a, R_TONE_C_HI
    ld   e, h
    call ay_write
    ret

kick_counter: DB 0
kick_period:  DW 0
```

**Хай-хет:** Дуже короткий сплеск шуму, висока частота шуму (низьке значення R6), негайне обрізання гучності через 1-2 кадри.

### Орнаменти: Покадрова модуляція

Орнамент -- це таблиця покадрових зсувів, що застосовуються до висоти або гучності ноти. Орнаменти вдихають життя в інакше статичні прямокутні хвилі: вібрато, ковзання висоти, тремоло, обвідні атаки/згасання -- все це досягається пошуком у таблиці.

```z80
; Example ornament: pitch vibrato
; Table of signed semitone offsets, applied once per frame
ornament_vibrato:
    DB 0, 0, 1, 1, 0, 0, -1, -1    ; 8-frame cycle
    DB $80                           ; end marker
```

Рушій програвача застосовує зсув орнаменту до значення періоду базової ноти кожний кадр, створюючи плавну модуляцію.

---

## 11.3 TurboSound: 2 x AY

Клони Pentagon і Scorpion представили TurboSound -- два чипи AY в одній машині. Другий чип адресується шляхом його вибору через бітовий патерн, записаний у порт $FFFD перед операціями з регістрами.

### Вибір чипа

На платі NedoPC TurboSound (найпоширеніший сучасний дизайн) вибір чипа працює через порт $FFFD:

```z80
; Select chip 0 (primary)
ld   bc, $FFFD
ld   a, $FF          ; bit pattern: select chip 0
out  (c), a

; Select chip 1 (secondary)
ld   bc, $FFFD
ld   a, $FE          ; bit pattern: select chip 1
out  (c), a
```

Після вибору чипа всі наступні читання та записи регістрів через $FFFD/$BFFD йдуть до цього чипа. На практиці твій музичний рушій обирає чип 0, оновлює всі його регістри, потім обирає чип 1 і оновлює його регістри.

### 6 каналів, справжнє стерео

TurboSound подвоює все: 6 тональних каналів, 2 незалежних генератори шуму, 2 незалежних генератори обвідної. Типове стерео-розташування:

| Чип | Канали | Стерео | Роль |
|-----|--------|--------|------|
| Чип 0 | A0, B0, C0 | Лівий або центр | Головна мелодія, гармонія, бас |
| Чип 1 | A1, B1, C1 | Правий або центр | Контрмелодія, пади, ударні |

Або змішай їх для широкого стерео-поля:
- Бас на обох чипах (центр)
- Головна мелодія на чипі 0 (ліворуч)
- Контрмелодія на чипі 1 (праворуч)
- Ударні розділені: кік на чипі 0, малий барабан/хай-хет на чипі 1

Те, що TurboSound змінює в музичному плані, є значним: на одному AY композитор постійно йде на жертви. Ти не можеш мати одночасно тривалу басову ноту, головну мелодію та удар барабана без перехоплення каналу. З TurboSound у тебе є простір. Виділений басовий канал, виділені ударні, і чотири голоси, що залишилися для мелодії та гармонії. Ера компромісів закінчується.

### Модифікація рушія

Адаптація рушія для одного AY до TurboSound є простою. Твій обробник переривань стає:

```z80
music_frame:
    ; Update chip 0
    ld   a, $FF
    ld   bc, $FFFD
    out  (c), a          ; select chip 0
    call update_chip0    ; write 14 registers

    ; Update chip 1
    ld   a, $FE
    ld   bc, $FFFD
    out  (c), a          ; select chip 1
    call update_chip1    ; write 14 registers
    ret
```

Цикл запису регістрів записує всі 14 регістрів з буфера в ОЗП. Для двох чипів ти підтримуєш два 14-байтних буфери і послідовно відправляєш їх. Загальна вартість: близько 28 інструкцій OUT, приблизно 400 тактів (T-state).

---

## 11.4 Triple AY на ZX Spectrum Next

ZX Spectrum Next йде далі: три AY-сумісних звукових чипи, що дають тобі 9 каналів. Але реалізація Next виходить за межі простого потроєння.

### Розширені можливості

Чипи AY у Next включають **поканальне стерео-панорамування**. Кожний канал може бути індивідуально направлений ліворуч, праворуч або в центр -- те, чого оригінальний AY ніколи не підтримував. Це контролюється через додаткові специфічні для Next регістри.

Три чипи адресуються через регістр Next $06 (налаштування периферії 2) або через стандартний порт $FFFD зі значеннями вибору чипа.

### 9 каналів: Оркестрове мислення

Дев'ять каналів принципово змінюють те, як ти підходиш до композиції на 8-бітному залізі. Замість хитрих трюків для імітації складності ти можеш мислити оркестрово:

| Канал | Призначення | Панорамування |
|-------|------------|---------------|
| Чип 0, A | Басова лінія | Центр |
| Чип 0, B | Ритм-гітара / пад | Ліворуч |
| Чип 0, C | Головна мелодія | Центр |
| Чип 1, A | Гармонія / контрмелодія | Праворуч |
| Чип 1, B | Арпеджований акорд | Ліворуч |
| Чип 1, C | Перкусія: кік + малий барабан | Центр |
| Чип 2, A | Хай-хет / тарілка | Праворуч |
| Чип 2, B | Звукові ефекти (зарезервовано) | Центр |
| Чип 2, C | Ембієнт / шари падів | Ліворуч |

Цього достатньо для по-справжньому багатих аранжувань. У тебе є виділений канал для SFX, який ніколи не перериває музику. У тебе є незалежні генератори шуму для багатошарової перкусії. Ти можеш утримувати акорди без арпеджіо. Характер AY залишається -- прямокутні хвилі залишаються прямокутними хвилями -- але композиторська свобода наближається до Amiga MOD-трекера з його чотирма семпл-каналами.

---

## 11.5 Архітектура музичного рушія

Музичний рушій -- це код, що читає паттерн-дані та записує регістри AY у правильному темпі. На Spectrum він живе всередині обробника переривань.

### Програвач на основі переривань

IM2 (режим переривань 2) ZX Spectrum спрацьовує раз за кадр -- кожну 1/50 секунди на PAL-системах. Музичний рушій підключається до цього:

```z80
; Setup: install IM2 handler
setup_im2:
    di
    ld   a, $C0          ; interrupt vector table at $C000
    ld   i, a
    im   2

    ; Fill vector table at $C000 with $C1C1
    ; Handler at $C1C1
    ld   hl, $C000
    ld   de, $C001
    ld   bc, 256
    ld   (hl), $C1
    ldir

    ; Place JP at $C1C1
    ld   a, $C3          ; JP opcode
    ld   ($C1C1), a
    ld   hl, isr_handler
    ld   ($C1C2), hl

    ei
    ret

isr_handler:
    push af
    push bc
    push de
    push hl
    ; ... push all registers you use ...

    call music_play      ; <-- the player routine

    ; ... pop all registers ...
    pop  hl
    pop  de
    pop  bc
    pop  af
    ei
    reti
```

### Цикл програвача

Процедура програвача, що викликається 50 разів на секунду, робить наступне:

1. Зменшує лічильник тривалості поточної ноти
2. Якщо він дорівнює нулю, переходить до наступної ноти в паттерні
3. Застосовує орнаменти та ефекти (арпеджіо, вібрато, ковзання) до кожного каналу
4. Обчислює фінальний період та гучність для кожного каналу
5. Записує всі 14 регістрів AY

Спрощений скелет:

```z80
music_play:
    ; Decrement speed counter
    ld   a, (speed_counter)
    dec  a
    ld   (speed_counter), a
    ret  nz              ; not time for a new row yet

    ; Reset speed counter
    ld   a, (song_speed)
    ld   (speed_counter), a

    ; Process each channel
    ld   ix, channel_a_data
    call process_channel
    ld   ix, channel_b_data
    call process_channel
    ld   ix, channel_c_data
    call process_channel

    ; Write all registers to AY
    call ay_flush_registers
    ret
```

### Бюджет кадру

Ось критичне питання: скільки тактів (T-state) може спожити музичний рушій, перш ніж він зголоднить основну програму?

Кадр -- це 71 680 тактів (T-state) на Pentagon (69 888 на 48K). Переривання спрацьовує на початку кадру. Якщо музичний програвач займає 5 000 тактів (T-state), основній програмі залишається 66 680 для візуальних ефектів.

Типові витрати:
- **Простий програвач** (без ефектів, без орнаментів): ~1 500-2 500 тактів (T-state)
- **Програвач Pro Tracker 3**: ~3 000-5 000 тактів (T-state)
- **Повний програвач Vortex Tracker II** з орнаментами та ефектами: ~4 000-7 000 тактів (T-state)
- **Програвач TurboSound** (2 чипи): ~6 000-10 000 тактів (T-state)

Для демо, що запускає вимогливий до тактів ефект, 7 000 тактів (T-state) на музику -- це значно -- близько 10% кадру. Плануй відповідно.

### Формати та трекери

Сучасний стандарт для AY-музики на Spectrum -- **Vortex Tracker II** (формат .pt3). Це крос-платформний трекер, що працює на Windows і виводить файли, які безпосередньо відтворюються перевіреними процедурами програвача на Z80.

| Формат | Трекер | Особливості | Розмір програвача |
|--------|--------|-------------|-------------------|
| .pt3 | Vortex Tracker II / Pro Tracker 3 | Орнаменти, семпли, ефекти | ~1,2-1,8 КБ |
| .asc | ASC Sound Master | Простіший, менший програвач | ~0,8-1,0 КБ |
| .sqt | SQ-Tracker | Компактний, гарне стиснення | ~0,6-0,8 КБ |
| .stc | Sound Tracker | Базовий, найстаріший | ~0,5-0,7 КБ |

**Конвеєр:**

1. Створи композицію у Vortex Tracker II на ПК
2. Експортуй як файл .pt3
3. Включи вихідний код програвача .pt3 (асемблер Z80) у свій проект
4. Включи файл даних .pt3 як бінарний блоб
5. Виклич `music_init` при запуску (передавши адресу даних пісні)
6. Викликай `music_play` з обробника переривань кожний кадр

```z80
; In your main code:
    ld   hl, song_data
    call music_init

; In your interrupt handler:
    call music_play

; At the end of the binary:
song_data:
    INCBIN "mysong.pt3"
```

Це стандартний підхід, що використовується практично кожним демо та грою для Spectrum 128K з початку 2000-х.

---

## 11.6 Система звукових ефектів

Ігри потребують звукових ефектів, а звукові ефекти потребують каналів. Стандартний підхід -- **перехоплення каналу на основі пріоритету**: коли спрацьовує звуковий ефект, він тимчасово забирає канал у музичного рушія, а потім звільняє його, коли ефект завершується.

### Перехоплення каналу

```z80
; Trigger a sound effect on the SFX channel
; HL = pointer to SFX data table
sfx_trigger:
    ld   (sfx_pointer), hl
    ld   a, 1
    ld   (sfx_active), a
    ld   a, 0
    ld   (sfx_frame), a
    ret

; Called every frame from the interrupt handler, AFTER music_play
sfx_update:
    ld   a, (sfx_active)
    or   a
    ret  z               ; no active SFX

    ; Read current SFX frame data
    ld   hl, (sfx_pointer)
    ld   a, (sfx_frame)
    ld   e, a
    ld   d, 0

    ; Each SFX frame: [tone_lo, tone_hi, noise, volume, mixer_mask]
    ; 5 bytes per frame
    push hl
    ld   b, 5
    call multiply_de_b   ; DE = frame * 5 (or use repeated add)
    pop  hl
    add  hl, de

    ld   a, (hl)
    cp   $FF             ; end marker?
    jr   z, .sfx_done

    ; Override channel C with SFX data
    ld   e, (hl) : inc hl
    ld   a, R_TONE_C_LO
    call ay_write

    ld   e, (hl) : inc hl
    ld   a, R_TONE_C_HI
    call ay_write

    ld   e, (hl) : inc hl
    ld   a, R_NOISE
    call ay_write

    ld   e, (hl) : inc hl
    ld   a, R_VOL_C
    call ay_write

    ; Advance frame counter
    ld   a, (sfx_frame)
    inc  a
    ld   (sfx_frame), a
    ret

.sfx_done:
    xor  a
    ld   (sfx_active), a ; deactivate SFX
    ret
```

### Процедурні таблиці SFX

Звукові ефекти визначаються як таблиці покадрових значень регістрів. Ось чотири класичних ігрових звуки:

**Вибух:** Шум зі згасаючою гучністю.

```z80
sfx_explosion:
    ; tone_lo, tone_hi, noise_period, volume, (unused)
    DB 0, 0, 15, 15, 0    ; frame 0: loud low noise
    DB 0, 0, 18, 13, 0    ; frame 1
    DB 0, 0, 20, 11, 0    ; frame 2
    DB 0, 0, 22, 9,  0    ; frame 3
    DB 0, 0, 25, 7,  0    ; frame 4
    DB 0, 0, 28, 5,  0    ; frame 5
    DB 0, 0, 30, 3,  0    ; frame 6
    DB 0, 0, 31, 1,  0    ; frame 7
    DB $FF                 ; end
```

**Лазер:** Швидкий спадний свіп тону.

```z80
sfx_laser:
    DB 10, 0, 0, 14, 0    ; frame 0: high tone
    DB 30, 0, 0, 13, 0    ; frame 1: sweeping down
    DB 60, 0, 0, 12, 0    ; frame 2
    DB 100,0, 0, 10, 0    ; frame 3
    DB 160,0, 0, 8,  0    ; frame 4
    DB 240,0, 0, 5,  0    ; frame 5
    DB 200,1, 0, 3,  0    ; frame 6: into low range
    DB $FF                 ; end
```

**Стрибок:** Короткий висхідний свіп тону.

```z80
sfx_jump:
    DB 200,0, 0, 12, 0    ; frame 0: mid tone
    DB 150,0, 0, 11, 0    ; frame 1: rising
    DB 100,0, 0, 10, 0    ; frame 2
    DB 60, 0, 0, 8,  0    ; frame 3: high
    DB 40, 0, 0, 5,  0    ; frame 4
    DB $FF                 ; end
```

**Підбирання предмета:** Швидке висхідне арпеджіо.

```z80
sfx_pickup:
    DB $D4,0, 0, 14, 0    ; frame 0: C5
    DB $A8,0, 0, 14, 0    ; frame 1: C4 (wrong dir? no:)
    ; Actually, let's go up:
    DB $FC,0, 0, 14, 0    ; frame 0: A4
    DB $D4,0, 0, 13, 0    ; frame 1: C5
    DB $A0,0, 0, 12, 0    ; frame 2: E5 (approx)
    DB $6A,0, 0, 11, 0    ; frame 3: C6 (approx)
    DB $6A,0, 0, 8,  0    ; frame 4: sustain
    DB $6A,0, 0, 4,  0    ; frame 5: fade
    DB $FF                 ; end
```

---

## 11.7 Збираємо все разом: Робочий приклад

Файл `chapters/ch11-sound/examples/ay_test.a80` містить повний приклад, що компілюється і демонструє основи: ініціалізацію AY, налаштування мікшера, запис періодів тону та програвання мелодії. Вивчай його паралельно з цим розділом -- кожна обговорена тут концепція використовується в цьому коді.

Ключові патерни, на які варто звернути увагу в прикладі:

1. **Двокроковий доступ до порту**: Вибір регістра через $FFFD, потім запис даних через $BFFD.
2. **Конфігурація мікшера**: $3E вмикає лише тон A (двійкове `111 110` -- пам'ятай, 0 = УВІМКНЕНО).
3. **Таблиця нот**: Попередньо обчислені значення періодів для кожної висоти тону.
4. **Таймінг на основі HALT**: Кожний `HALT` чекає одного переривання, даючи тайм-роздільну здатність 50 Гц.

Щоб розширити цей приклад до справжнього музичного програвача, ти б замінив лінійну таблицю мелодій на паттерн-дані, додав обробку орнаментів і перемістив відтворення в обробник переривань IM2, щоб головний цикл був вільний для візуальних ефектів.

---

> ## Врізка: Біпер -- Коротка історія неможливого
>
> До 128K та його чипа AY оригінальний 48K Spectrum мав рівно один біт звукового виходу. Пін 4 порту $FE. Високий або низький. Це все.
>
> Один біт означає одну прямокутну хвилю з будь-якою частотою, з якою ти його перемикаєш. Без контролю гучності, без мікшування, без апаратної допомоги. Щоб відтворити ноту, ти сидиш у тісному циклі, перемикаючи біт з потрібною частотою. Щоб відтворити *дві* ноти, ти чергуєш два цикли перемикання. Щоб три -- чергуєш три. Кожний додатковий голос з'їдає процесорний час, який міг би робити щось інше -- наприклад, малювати графіку.
>
> І все ж.
>
> Між 2010 і 2015 роками Shiru (Shiru Otaku) каталогізував приблизно 30 різних біперних рушіїв, кожний з яких використовував іншу техніку для видобування поліфонії з одного біта. Підходи варіювалися від простого чергування імпульсів (2-3 канали) до надзвичайних інженерних подвигів:
>
> - **ZX-16** від Jan Deak: 16-канальна поліфонія на одному біті. Шістнадцять. Процесор не робить нічого, крім перемикання біта динаміка за ретельно розрахованим розкладом, що апроксимує суму 16 незалежних хвильових форм через імпульсно-щільнісну модуляцію.
>
> - **Octode XL**: 8-канальний біперний рушій, який реально залишає достатньо процесорного часу для візуальних ефектів.
>
> - **Rain** від Life on Mars (2016): Повне демо, що запускає 9-канальний біперний рушій *одночасно з візуальними ефектами* на 48K Spectrum. Вся продукція -- музика і графіка -- працює без чипа AY, без перемикання банків, без нічого понад базову машину.
>
> Це одні з найбільш вражаючих інженерних досягнень в 8-бітних обчисленнях. Вони доводять, що межі більш проникні, ніж здаються. Але вони також непрактичні для загального використання: більшість біперних рушіїв споживають 50-90% процесорного часу, майже не залишаючи нічого для ігрового процесу або ефектів. Чип AY існує саме для того, щоб розвантажити генерацію звуку на спеціалізоване обладнання.
>
> Ми висвітлюємо біперні рушії тут як історичний контекст та натхнення. Для практичної музики у твоїх демо та іграх AY -- це те, на чому варто зосередити зусилля.

---

> ## Врізка: Agon Light 2 -- Звукова система VDP
>
> Agon Light 2 використовує зовсім інший підхід до звуку. Його аудіо генерується співпроцесором ESP32 (VDP), а не виділеним звуковим чипом. Ти надсилаєш VDU-команди через послідовний зв'язок, і ESP32 синтезує звук програмно.
>
> **Форми хвиль:** Звукова система Agon пропонує кілька типів форм хвиль на канал -- прямокутну, синусоїдальну, трикутну, пилкоподібну та шум. Це вже гнучкіше, ніж тональні генератори AY, що працюють лише з прямокутними хвилями.
>
> **Обвідні ADSR:** Кожний канал має повністю програмовану обвідну Attack-Decay-Sustain-Release. Без спільного використання -- кожний канал отримує власну незалежну обвідну, на відміну від єдиного спільного генератора обвідної AY.
>
> **Кількість каналів:** Звукова система VDP підтримує кілька одночасних каналів (точна кількість залежить від версії прошивки, але зазвичай 8 або більше).
>
> **Компроміс:** Звук Agon контролюється через послідовності байт VDU, що надсилаються через послідовний зв'язок. Це означає:
> - Вищу затримку порівняно з прямими записами в регістри (час передачі через послідовний зв'язок)
> - Менш точний таймінг (ти не можеш маніпулювати бітами з точністю до такту (T-state))
> - Але значно менше навантаження на процесор (eZ80 просто надсилає команди; ESP32 виконує весь синтез)
>
> Парадигма ближча до MIDI, ніж до програмування на рівні регістрів. Ти кажеш VDP "відтвори цю ноту на каналі 3 з синусоїдальною хвилею і цією обвідною ADSR", і він робить решту. Музичні цілі ті самі -- мелодія, бас, ударні, ефекти -- але модель програмування принципово інша. Без регістра мікшера, без обчислень періодів, без таблиць форм обвідних. Лише команди та параметри.
>
> Для крос-платформних проектів розглянь абстрагування звукової системи за спільним API: `sound_play_note(channel, note, instrument)`. На Spectrum пошук інструмента записує регістри AY. На Agon він надсилає VDU-команди. Ті самі музичні дані, різні бекенди.

---

## 11.8 Практичні вправи

**Вправа 1: Дослідник регістрів.** Напиши програму, що дозволяє змінювати будь-який регістр AY у реальному часі за допомогою клавіатурного вводу. Відображай усі 14 значень регістрів на екрані. Це твій найкорисніший інструмент налагодження для роботи зі звуком.

**Вправа 2: Аранжування на три канали.** Створи простий 16-тактовий твір з використанням усіх трьох каналів: мелодія на A, бас (buzz-bass через обвідну) на C, арпеджовані акорди на B. Використай таймінг на основі HALT з прикладу як початкову точку, потім перероби його на програвач, керований IM2.

**Вправа 3: Набір ударних.** Реалізуй чотири звуки ударних (кік, малий барабан, хай-хет, крашт) як процедурні таблиці SFX. Напиши простий ритмічний патерн, що відтворює їх послідовно. Інтегруй з мелодією з Вправи 2.

**Вправа 4: Інтеграція Vortex Tracker.** Завантаж Vortex Tracker II, створи коротку мелодію, експортуй як .pt3 та інтегруй стандартний програвач .pt3 у програму для Spectrum. Перевір, що вона правильно відтворюється в емуляторі.

---

## Підсумок

AY-3-8910 оманливо простий: 14 регістрів, 3 канали, базові форми хвиль. Але розрив між "простим" та "обмеженим" заповнюється технікою. Арпеджіо імітують акорди. Зловживання обвідною створює бас. Формування шуму синтезує ударні. Орнаменти вдихають життя в статичні тони. І коли трьох каналів справді не вистачає, TurboSound подвоює їх, а Next потроює.

Архітектурний патерн однаковий для всіх конфігурацій: переривання спрацьовує 50 разів на секунду, процедура програвача читає паттерн-дані та обчислює значення регістрів, і ці значення відправляються на AY у тісному циклі. Незалежно від того, пишеш ти власний програвач чи інтегруєш Vortex Tracker, потік той самий. Розуміння регістрів означає розуміння звуку.

У наступному розділі ми застосуємо це на практиці: цифрові барабанні семпли, змішані з відтворенням AY, покадрово точна синхронізація між музикою та візуальними ефектами, і скриптові рушії, що зв'язують демо воєдино.

---

> **Джерела:** Dark "GS Sound System" (Spectrum Expert #01, 1997); Dark "Music" (Spectrum Expert #02, 1998); Shiru "Beeper 20XX" (Hype 2016); Rain file_id.diz; Info Guide #14 ASC Sound Master docs (ZXArt 2024); Vortex Tracker II documentation
